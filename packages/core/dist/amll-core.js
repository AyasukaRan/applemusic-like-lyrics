var J=Object.defineProperty;var Z=(d,s,e)=>s in d?J(d,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[s]=e;var r=(d,s,e)=>(Z(d,typeof s!="symbol"?s+"":s,e),e);import{Container as K}from"@pixi/display";import{Application as Q}from"@pixi/app";import{BlurFilter as S}from"@pixi/filter-blur";import{ColorMatrixFilter as O}from"@pixi/filter-color-matrix";import{Texture as ee}from"@pixi/core";import{Sprite as X}from"@pixi/sprite";import{BulgePinchFilter as H}from"@pixi/filter-bulge-pinch";import{create as te}from"jss";import ie from"jss-preset-default";class V{}class N extends V{constructor(e){super();r(this,"observer");r(this,"flowSpeed",2);r(this,"currerntRenderScale",.75);this.canvas=e,this.observer=new ResizeObserver(()=>{const t=Math.max(1,e.clientWidth*window.devicePixelRatio*this.currerntRenderScale),i=Math.max(1,e.clientHeight*window.devicePixelRatio*this.currerntRenderScale);this.onResize(t,i)}),this.observer.observe(e)}setRenderScale(e){this.currerntRenderScale=e,this.onResize(this.canvas.clientWidth*window.devicePixelRatio*this.currerntRenderScale,this.canvas.clientHeight*window.devicePixelRatio*this.currerntRenderScale)}onResize(e,t){this.canvas.width=e,this.canvas.height=t}setFlowSpeed(e){this.flowSpeed=e}dispose(){this.observer.disconnect(),this.canvas.remove()}}class se extends K{constructor(){super(...arguments);r(this,"time",0)}}class le extends N{constructor(e){super(e);r(this,"app");r(this,"curContainer");r(this,"staticMode",!1);r(this,"lastContainer",new Set);r(this,"onTick",e=>{for(const t of this.lastContainer)t.alpha=Math.max(0,t.alpha-e/60),t.alpha<=0&&(this.app.stage.removeChild(t),this.lastContainer.delete(t),t.destroy(!0));if(this.curContainer){this.curContainer.alpha=Math.min(1,this.curContainer.alpha+e/60);const[t,i,l,n]=this.curContainer.children,a=Math.max(this.app.screen.width,this.app.screen.height);t.position.set(this.app.screen.width/2,this.app.screen.height/2),i.position.set(this.app.screen.width/2.5,this.app.screen.height/2.5),l.position.set(this.app.screen.width/2,this.app.screen.height/2),n.position.set(this.app.screen.width/2,this.app.screen.height/2),t.width=a*Math.sqrt(2),t.height=t.width,i.width=a*.8,i.height=i.width,l.width=a*.5,l.height=l.width,n.width=a*.25,n.height=n.width,this.curContainer.time+=e*this.flowSpeed,t.rotation+=e/1e3*this.flowSpeed,i.rotation-=e/500*this.flowSpeed,l.rotation+=e/1e3*this.flowSpeed,n.rotation-=e/750*this.flowSpeed,l.x=this.app.screen.width/2+this.app.screen.width/4*Math.cos(this.curContainer.time/1e3*.75),l.y=this.app.screen.height/2+this.app.screen.width/4*Math.cos(this.curContainer.time/1e3*.75),n.x=this.app.screen.width/2+this.app.screen.width/4*.1+Math.cos(this.curContainer.time*.006*.75),n.y=this.app.screen.height/2+this.app.screen.width/4*.1+Math.cos(this.curContainer.time*.006*.75),this.curContainer.alpha>=1&&this.lastContainer.size===0&&this.staticMode&&this.app.ticker.stop()}});this.canvas=e,this.app=new Q({view:e,resizeTo:this.canvas,powerPreference:"low-power",backgroundAlpha:1}),this.rebuildFilters(),this.app.ticker.maxFPS=30,this.app.ticker.add(this.onTick),this.app.ticker.start()}onResize(e,t){super.onResize(e,t),this.app.resize(),this.rebuildFilters()}setRenderScale(e){super.setRenderScale(e),this.rebuildFilters()}rebuildFilters(){var a;const e=Math.min(this.canvas.width,this.canvas.height),t=Math.max(this.canvas.width,this.canvas.height),i=new O;i.saturate(1.2,!1);const l=new O;l.brightness(.6,!1);const n=new O;n.contrast(.3,!0),(a=this.app.stage.filters)==null||a.forEach(o=>{o.destroy()}),this.app.stage.filters=[],this.app.stage.filters.push(new S(5,1)),this.app.stage.filters.push(new S(10,1)),this.app.stage.filters.push(new S(20,2)),this.app.stage.filters.push(new S(40,2)),this.app.stage.filters.push(new S(80,2)),e>768&&this.app.stage.filters.push(new S(160,4)),e>768*2&&this.app.stage.filters.push(new S(320,4)),this.app.stage.filters.push(i,l,n),this.app.stage.filters.push(new S(5,1)),Math.random()>.5?(this.app.stage.filters.push(new H({radius:(t+e)/2,strength:1,center:[.25,1]})),this.app.stage.filters.push(new H({radius:(t+e)/2,strength:1,center:[.75,0]}))):(this.app.stage.filters.push(new H({radius:(t+e)/2,strength:1,center:[.75,1]})),this.app.stage.filters.push(new H({radius:(t+e)/2,strength:1,center:[.25,0]})))}setStaticMode(e=!1){this.staticMode=e,this.app.ticker.start()}setFPS(e){this.app.ticker.maxFPS=e}pause(){this.app.ticker.stop(),this.app.render()}resume(){this.app.ticker.start()}setLowFreqVolume(e){}setHasLyric(e){}async setAlbumImage(e){var I,m;if(e.trim().length===0)return;const t=new Image;t.src=e,t.crossOrigin="anonymous";let i=5,l;for(;!((m=(I=l==null?void 0:l.baseTexture)==null?void 0:I.resource)!=null&&m.valid)&&i>0;)try{await t.decode(),l=ee.from(t,{resourceOptions:{autoLoad:!1}}),await l.baseTexture.resource.load()}catch(g){console.warn(`failed on loading album image, retrying (${i})`,e,g),l=void 0,i--}if(!l)return;const n=new se,a=new X(l),o=new X(l),c=new X(l),h=new X(l);a.anchor.set(.5,.5),o.anchor.set(.5,.5),c.anchor.set(.5,.5),h.anchor.set(.5,.5),a.rotation=Math.random()*Math.PI*2,o.rotation=Math.random()*Math.PI*2,c.rotation=Math.random()*Math.PI*2,h.rotation=Math.random()*Math.PI*2,n.addChild(a,o,c,h),this.curContainer&&this.lastContainer.add(this.curContainer),this.curContainer=n,this.app.stage.addChild(n),this.curContainer.alpha=0,this.app.ticker.start()}dispose(){super.dispose(),this.app.ticker.remove(this.onTick),this.app.destroy(!0)}getElement(){return this.canvas}}const z=`#version 300 es
precision highp float;

in vec2 v_coord;
out vec2 f_v_coord;

void main() {
    gl_Position = vec4(v_coord, 0.0f, 1.0f);
    f_v_coord = (vec2(v_coord.x, v_coord.y) + vec2(1.0f, 1.0f)) / 2.0f;
}
`,re=`#version 300 es
precision highp float;

uniform sampler2D src;
in vec2 f_v_coord;
out vec4 fragColor;

void main() {
    vec2 coord = f_v_coord;
    fragColor = texture(src, coord);
}
`,ne=`#version 300 es
precision highp float;

uniform sampler2D src;
uniform float lerp;
uniform float scale;
in vec2 f_v_coord;
out vec4 fragColor;

void main() {
    vec2 tex_coord = f_v_coord;
    if(scale < 1.0f) {
        tex_coord /= scale;
    }
    vec4 srcColor = texture(src, tex_coord);
    fragColor = mix(vec4(srcColor.xyz, 0.0f), srcColor, lerp);
}
`,ae=`#version 300 es
precision highp float;
uniform float IIIlllllllIIIllIl,lIIIlllllIllIl,IIIlllIlIIllll;
uniform sampler2D IlllIIlIlllIll;
uniform vec2 IIlIlIIlIlIllI;
out vec4 lIIlIIIIIlIlIlllIIIIlIIl;
mat2 rotate2d(float _angle){
    return mat2(cos(_angle),-sin(_angle),
                sin(_angle),cos(_angle));
}
float IllllIIlIllII(float llIIllIllIIIllI)
{
  return fract(sin(llIIllIllIIIllI)*43758.5453);
}
float llIlIIllllIII(vec2 IIIlIIlIIIlllIII)
{
  vec2 IIllIlIIlllI=floor(IIIlIIlIIIlllIII),lIlIllIIIIIlIl=fract(IIIlIIlIIIlllIII);
  lIlIllIIIIIlIl=lIlIllIIIIIlIl*lIlIllIIIIIlIl*(3.-2.*lIlIllIIIIIlIl);
  float lIlIlIlIlIlIIl=IIllIlIIlllI.x+IIllIlIIlllI.y*57.;
  return mix(mix(IllllIIlIllII(lIlIlIlIlIlIIl),IllllIIlIllII(lIlIlIlIlIlIIl+1.),lIlIllIIIIIlIl.x),mix(IllllIIlIllII(lIlIlIlIlIlIIl+57.),IllllIIlIllII(lIlIlIlIlIlIIl+58.),lIlIllIIIIIlIl.x),lIlIllIIIIIlIl.y);
}
vec2 lllIIIIIIllIlIIIlI(vec2 IlllIIlIIIIlIIII,float lIIIIlllIIIIllIlIlI,vec2 IlIlIIIIlIlllIlIII)
{
  float lIIlIllIIIlIl=llIlIIllllIII(IlllIIlIIIIlIIII*1.+sin(.2*lIIIlllllIllIl)*.1+.1)*3.2831;
  IlllIIlIIIIlIIII+=vec2(.0,.5);
  lIIlIllIIIlIl+=llIlIIllllIII(IlllIIlIIIIlIIII*vec2(1.0,1.)*3.5-sin(.3*lIIIlllllIllIl)*.1+.1)*2.2831*IIIlllllllIIIllIl;
  lIIlIllIIIlIl-=lIIIIlllIIIIllIlIlI;
  return vec2(cos(lIIlIllIIIlIl),sin(lIIlIllIIIlIl));
}
const mat3 lIIllIIIlllIl=mat3(1.,.02,.002,.02,1.,.008,.002,.02,1.),lIIIlllIIIIll=mat3(1.022,-.02,-.002,-.02,1.028,-.008,-.002,-.02,1.022);
vec3 IllllIIIlIlllI(vec3 lIlIIlIlIIIllIll)
{
  lIlIIlIlIIIllIll*=lIIllIIIlllIl;
  lIlIIlIlIIIllIll=pow(lIlIIlIlIIIllIll,vec3(3));
  lIlIIlIlIIIllIll/=1.+lIlIIlIlIIIllIll;
  lIlIIlIlIIIllIll=pow(lIlIIlIlIIIllIll,vec3(1./3.));
  lIlIIlIlIIIllIll*=lIIIlllIIIIll;
  return clamp(lIlIIlIlIIIllIll,vec3(0),vec3(1));
}

float gradientNoise(in vec2 uv)
{
	return fract(52.9829189 * fract(dot(uv, vec2(0.06711056, 0.00583715))));
}

void main()
{
  // lIIlIIIIIlIlIlllIIIIlIIl=texture(IlllIIlIlllIll,gl_FragCoord.xy/IIlIlIIlIlIllI.xy);
  // return;
  vec2 lIIIlIIllIlIIlI=sin(lIIIlllllIllIl*.1)*.3+.1+gl_FragCoord.xy/IIlIlIIlIlIllI.xy,lIIllIIlIIIllI=lIIIlIIllIlIIlI*.8f+vec2(-0.8f,-.3f);
  lIIllIIlIIIllI.x*=IIlIlIIlIlIllI.x/IIlIlIIlIlIllI.y;
  float lIIlIIlIIlIIIlII=gl_FragCoord.x/max(IIlIlIIlIlIllI.x,IIlIlIIlIlIllI.y),lIIIlIllIllIlIIl=0.f;
  vec3 lIIIlIlIIIlIlIIl=texture(IlllIIlIlllIll,-lIIIlllllIllIl*.1+1.*lIIllIIlIIIllI*rotate2d(lIIIlllllIllIl*.4)).xyz;
  vec2 lIlIIlIlIIIllIll=lIIllIIlIIIllI;
  for(int IllIlIIlIIlllllIIIl=0;IllIlIIlIIlllllIIIl<8;IllIlIIlIIlllllIIIl++)
    {
      vec2 lIllIIlIIlIIIll=lllIIIIIIllIlIIIlI(lIIllIIlIIIllI,lIIlIIlIIlIIIlII,lIIIlIIllIlIIlI);
      float lIIlIlIIlIIlIllI=float(IllIlIIlIIlllllIIIl)/16.f,lIIllIIlIIIIlIII=4.f*lIIlIlIIlIIlIllI*(1.f-lIIlIlIIlIIlIllI);
      vec3 llIIlIIIIlIIlIII=lIIllIIlIIIIlIII*texture(IlllIIlIlllIll,lIIIlllllIllIl*.1+lIIllIIlIIIllI*rotate2d(lIIIlllllIllIl*.4)+(3.-IIIlllIlIIllll)*.2*(IllIlIIlIIlllllIIIl%2==0?-1.:1.2)).xyz;
      // vec3 llIIlIIIIlIIlIII=lIIllIIlIIIIlIII*texture(IlllIIlIlllIll,(IllIlIIlIIlllllIIIl%2==0?lIIllIIlIIIllI-IIIlllIlIIllll*.2:vec2(1.)-lIIllIIlIIIllI*1.2+IIIlllIlIIllll*.2)*rotate2d(lIIIlllllIllIl*.4)).xyz;
      llIIlIIIIlIIlIII*=mix(vec3(.9),vec3(1),.5-.5*dot(reflect(vec3(lIllIIlIIlIIIll,0),vec3(1,0,0)).xy,vec2(.707)));
      lIIIlIlIIIlIlIIl+=lIIllIIlIIIIlIII*llIIlIIIIlIIlIII;
      lIIIlIllIllIlIIl+=lIIllIIlIIIIlIII;
      // if (IllIlIIlIIlllllIIIl >= 4) {
      //   lIIllIIlIIIllI+=.03f*lIllIIlIIlIIIll*(sin(lIIIlllllIllIl*2.)*.9+.5)*3.;
      // } else {
      //   lIIllIIlIIIllI+=.01f*lIllIIlIIlIIIll*(sin(lIIIlllllIllIl*2.)*.5+.9)*3.;
      // }
      lIIllIIlIIIllI+=.05f*lIllIIlIIlIIIll*(sin(lIIIlllllIllIl*2.)*.3+1.2);
      lIlIIlIlIIIllIll+=.05f*lIllIIlIIlIIIll;
    }
  lIIIlIlIIIlIlIIl/=lIIIlIllIllIlIIl;
  vec2 IIlllIIlIllIIlI=lllIIIIIIllIlIIIlI(lIlIIlIlIIIllIll,lIIlIIlIIlIIIlII,lIIIlIIllIlIIlI);
  // lIIIlIlIIIlIlIIl*=.95f+.35f*dot(IIlllIIlIllIIlI,vec2(.707f));
  // lIIIlIlIIIlIlIIl*=.2f+.8f*pow(2.f*lIIIlIIllIlIIlI.x*(1.f-lIIIlIIllIlIIlI.x),.1f);
  lIIIlIlIIIlIlIIl*=2.8f;
  lIIIlIlIIIlIlIIl=1.f-exp(-lIIIlIlIIIlIlIIl);
  lIIIlIlIIIlIlIIl=pow(lIIIlIlIIIlIlIIl,vec3(2.0));
  lIIIlIlIIIlIlIIl*=.9f;
  lIIIlIlIIIlIlIIl=IllllIIIlIlllI(lIIIlIlIIIlIlIIl);
  // lIIIlIlIIIlIlIIl += (1.0 / 255.0) * gradientNoise(gl_FragCoord.xy) - (0.5 / 255.0);
  lIIlIIIIIlIlIlllIIIIlIIl=vec4(lIIIlIlIIIlIlIIl,1);
}`,oe=`#version 300 es
precision highp float;

uniform sampler2D src;
uniform float frameTime;
in vec2 f_v_coord;
out vec4 fragColor;

float nrand(vec2 n) {
    return fract(sin(dot(n.xy, vec2(12.9898f, 78.233f))) * 43758.5453f);
}

vec3 nrand3(vec2 n) {
    return vec3(nrand(n), nrand(n + vec2(0.15f)), nrand(n + vec2(0.3f)));
}

float blur_radius = 0.02f; //Blur radius, tweak it ;)

/* Gradient noise from Jorge Jimenez's presentation: */
/* http://www.iryoku.com/next-generation-post-processing-in-call-of-duty-advanced-warfare */
float gradientNoise(in vec2 uv)
{
	return fract(52.9829189 * fract(dot(uv, vec2(0.06711056, 0.00583715))));
}

void main() {
    vec2 tex_coord = f_v_coord;

    float dither = (1.0 / 255.0) * gradientNoise(gl_FragCoord.xy) - (0.5 / 255.0);

    vec4 color = texture(src, tex_coord);

    #if 1
    int count = 0;
    vec3 sampled_color = vec3(0.0f);
    for(float i = -2.f; i <= 2.f; i += 1.f) {
        for(float j = -2.f; j <= 2.f; j += 1.f) {
            vec2 offset = blur_radius * (fract(vec2(0.61803398875f, 0.38196601125f) * 1.f) - 0.5f + vec2(sin(i), cos(j)) / 32.f) + dither * .5;
            sampled_color += textureLod(src, offset + tex_coord, 3.0f).xyz;
            count++;
        }
    }
    sampled_color /= vec3(count);
    #else
    vec2 offset = blur_radius * (fract(vec2(0.61803398875f, 0.38196601125f) * 1.f) - 0.5f) + dither * .5;
    vec3 sampled_color = textureLod(src, offset - tex_coord, 3.0f).xyz;
    #endif

    vec3 deviation = sampled_color - color.rgb;

    vec3 blend_factor = vec3(lessThan(deviation, vec3(0.03f)));

    color.rgb = mix(color.rgb, sampled_color, blend_factor);

    color += dither;
    fragColor = color;
}
`,he=`#version 300 es\r
precision highp float;\r
\r
uniform sampler2D src;\r
uniform sampler2D historyFrame0;\r
uniform vec2 texSize;\r
in vec2 f_v_coord;\r
out vec4 fragColor;\r
\r
void main() {\r
    fragColor = texture(src, f_v_coord);\r
    return;\r
    // get the neighborhood min / max from this frame's render\r
    vec3 center = texture(src, f_v_coord).rgb;\r
    vec3 minColor = center;\r
    vec3 maxColor = center;\r
    for (int iy = -1; iy <= 1; ++iy)\r
    {\r
        for (int ix = -1; ix <= 1; ++ix)\r
        {\r
            if (ix == 0 && iy == 0)\r
                continue;\r
            \r
           \r
            vec2 offsetUV = ((f_v_coord * texSize + vec2(ix, iy))) / texSize;\r
            vec3 color = texture(src, offsetUV).rgb;\r
            minColor = min(minColor, color);\r
            maxColor = max(maxColor, color);\r
        }\r
    }\r
    \r
    // get last frame's pixel and clamp it to the neighborhood of this frame\r
    vec3 old = texture(historyFrame0, f_v_coord).rgb;    \r
    old = max(minColor, old);\r
    old = min(maxColor, old);\r
    \r
    // interpolate from the clamped old color to the new color.\r
    // Reject all history when the mouse moves.\r
    float lerpAmount = 0.1f;\r
    vec3 pixelColor = mix(old, center, lerpAmount);        \r
    fragColor = vec4(pixelColor, 1.0f);\r
}`;function Ie(d,s,e){const t=d.data,i=d.width,l=d.height;let n,a,o,c,h,I,m,g,u,y,p,f,T;const b=i-1,x=l-1,E=s+1,A=s+E,v=s+1,D=s+v,k=1/(A*D),P=[],_=[],R=[],M=[],B=[],U=[];for(;e-- >0;){for(T=f=0,I=0;I<l;I++){for(n=t[T]*E,a=t[T+1]*E,o=t[T+2]*E,c=t[T+3]*E,m=1;m<=s;m++)g=T+((m>b?b:m)<<2),n+=t[g++],a+=t[g++],o+=t[g++],c+=t[g];for(h=0;h<i;h++)P[f]=n,_[f]=a,R[f]=o,M[f]=c,I===0&&(B[h]=Math.min(h+E,b)<<2,U[h]=Math.max(h-s,0)<<2),u=T+B[h],y=T+U[h],n+=t[u++]-t[y++],a+=t[u++]-t[y++],o+=t[u++]-t[y++],c+=t[u]-t[y],f++;T+=i<<2}for(h=0;h<i;h++){for(p=h,n=P[p]*v,a=_[p]*v,o=R[p]*v,c=M[p]*v,m=1;m<=s;m++)p+=m>x?0:i,n+=P[p],a+=_[p],o+=R[p],c+=M[p];for(f=h<<2,I=0;I<l;I++)t[f]=n*k+.5|0,t[f+1]=a*k+.5|0,t[f+2]=o*k+.5|0,t[f+3]=c*k+.5|0,h===0&&(B[I]=Math.min(I+v,x)*i,U[I]=Math.max(I-s,0)*i),u=h+B[I],y=h+U[I],n+=P[u]-P[y],a+=_[u]-_[y],o+=R[u]-R[y],c+=M[u]-M[y],f+=i<<2}}}function ce(d,s){const e=d.data;for(let t=0;t<e.length;t+=4){const i=e[t],l=e[t+1],n=e[t+2],a=e[t+3],o=i*.3+l*.59+n*.11;e[t]=o*(1-s)+i*s,e[t+1]=o*(1-s)+l*s,e[t+2]=o*(1-s)+n*s,e[t+3]=a}}function de(d,s){const e=d.data;for(let t=0;t<e.length;t+=4){const i=e[t],l=e[t+1],n=e[t+2],a=e[t+3];e[t]=(i-128)*s+128,e[t+1]=(l-128)*s+128,e[t+2]=(n-128)*s+128,e[t+3]=a}}class F{constructor(s,e,t){r(this,"gl");r(this,"program");r(this,"vertexShader");r(this,"fragmentShader");r(this,"coordPos");r(this,"notFoundUniforms",new Set);this.gl=s,this.vertexShader=this.createShader(s.VERTEX_SHADER,e),this.fragmentShader=this.createShader(s.FRAGMENT_SHADER,t),this.program=this.createProgram();const i=s.getAttribLocation(this.program,"v_coord");if(i===-1)throw new Error("Failed to get attribute location v_coord");this.coordPos=i}createShader(s,e){const t=this.gl,i=t.createShader(s);if(!i)throw new Error("Failed to create shader");if(t.shaderSource(i,e),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw new Error(`Failed to compile shader for type ${s}: ${t.getShaderInfoLog(i)}`);return i}createProgram(){const s=this.gl,e=s.createProgram();if(!e)throw new Error("Failed to create program");if(s.attachShader(e,this.vertexShader),s.attachShader(e,this.fragmentShader),s.linkProgram(e),s.validateProgram(e),!s.getProgramParameter(e,s.LINK_STATUS)){const t=s.getProgramInfoLog(e);throw s.deleteProgram(e),new Error(`Failed to link program: ${t}`)}return e}use(){const s=this.gl;s.useProgram(this.program),s.vertexAttribPointer(this.coordPos,2,s.FLOAT,!1,0,0),s.enableVertexAttribArray(this.coordPos)}warnUniformNotFound(s){this.notFoundUniforms.has(s)||(this.notFoundUniforms.add(s),console.warn(`Failed to get uniform location: ${s}`))}setUniform1f(s,e){const t=this.gl,i=t.getUniformLocation(this.program,s);i?t.uniform1f(i,e):this.warnUniformNotFound(s)}setUniform2f(s,e,t){const i=this.gl,l=i.getUniformLocation(this.program,s);l?i.uniform2f(l,e,t):this.warnUniformNotFound(s)}setUniform1i(s,e){const t=this.gl,i=t.getUniformLocation(this.program,s);i?t.uniform1i(i,e):this.warnUniformNotFound(s)}dispose(){const s=this.gl;s.deleteShader(this.vertexShader),s.deleteShader(this.fragmentShader),s.deleteProgram(this.program)}}class ${constructor(s,e,t){r(this,"fb");r(this,"tex");r(this,"_size");this.gl=s,this._size=[e,t];const i=s.createFramebuffer();if(!i)throw new Error("Can't create framebuffer");const l=s.createTexture();if(!l)throw new Error("Failed to create texture");this.fb=i,this.tex=l,s.bindFramebuffer(s.FRAMEBUFFER,i),s.bindTexture(s.TEXTURE_2D,l),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,l,0),this.resize(e,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.MIRRORED_REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.MIRRORED_REPEAT)}get size(){return this._size}resize(s,e){const t=this.gl;this.bind(),t.bindTexture(t.TEXTURE_2D,this.tex),t.getExtension("EXT_color_buffer_float")?t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,s,e,0,t.RGBA,t.FLOAT,null):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,s,e,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.MIRRORED_REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.MIRRORED_REPEAT)}bind(){const s=this.gl;s.bindFramebuffer(s.FRAMEBUFFER,this.fb)}active(s=this.gl.TEXTURE0){this.gl.activeTexture(s),this.gl.bindTexture(this.gl.TEXTURE_2D,this.tex)}dispose(){this.gl.deleteFramebuffer(this.fb),this.gl.deleteTexture(this.tex)}}class W{constructor(s,e,t,i){r(this,"gl");r(this,"buffer");r(this,"type");r(this,"data");r(this,"usage");r(this,"length");this.gl=s,this.type=e,this.data=t,this.usage=i;const l=s.createBuffer();if(!l)throw new Error("Failed to create buffer");this.buffer=l,this.length=t.byteLength,s.bindBuffer(e,this.buffer),s.bufferData(e,t,i)}bind(){this.gl.bindBuffer(this.type,this.buffer)}dispose(){this.gl.deleteBuffer(this.buffer)}}class me{constructor(s,e,t,i,l){r(this,"albumTexture");r(this,"alpha",0);this.gl=s,this.mainProgram=e,this.vertexBuffer=t,this.indexBuffer=i;const n=s.createTexture();if(!n)throw new Error("Failed to create texture");this.albumTexture=n,s.bindTexture(s.TEXTURE_2D,n),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,l),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.MIRRORED_REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.MIRRORED_REPEAT)}draw(s){const e=this.gl;this.mainProgram.use(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.albumTexture),this.mainProgram.setUniform1i(s,0),e.drawArrays(e.TRIANGLE_STRIP,0,4)}dispose(){this.gl.deleteTexture(this.albumTexture)}}const L=class L extends N{constructor(e){super(e);r(this,"hasLyric",!0);r(this,"hasLyricValue",1);r(this,"maxFPS",30);r(this,"lastTickTime",0);r(this,"lastFrameTime",0);r(this,"_lowFreqVolume",1);r(this,"paused",!1);r(this,"staticMode",!1);r(this,"gl",this.setupGL());r(this,"reduceImageSizeCanvas",new OffscreenCanvas(128,128));r(this,"tickHandle",0);r(this,"sprites",[]);r(this,"ampTransition",0);r(this,"playTime",0);r(this,"frameTime",0);r(this,"mainProgram",new F(this.gl,z,ae));r(this,"blendProgram",new F(this.gl,z,ne));r(this,"copyProgram",new F(this.gl,z,re));r(this,"noiseProgram",new F(this.gl,z,oe));r(this,"taaProgram",new F(this.gl,z,he));r(this,"vertexBuffer",new W(this.gl,this.gl.ARRAY_BUFFER,L.rawVertexBuffer,this.gl.STATIC_DRAW));r(this,"indexBuffer",new W(this.gl,this.gl.ELEMENT_ARRAY_BUFFER,L.rawIndexBuffer,this.gl.STATIC_DRAW));r(this,"fb");r(this,"historyFrameBuffer",[]);r(this,"_currentSize",[0,0]);r(this,"_targetSize",[0,0]);r(this,"renderSize",[0,0]);r(this,"pixelSize",[0,0]);this.canvas=e;const t=this.gl;t.enable(this.gl.BLEND),t.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.requestTick();const i=e.getBoundingClientRect(),l=i.width*window.devicePixelRatio*this.currerntRenderScale,n=i.height*window.devicePixelRatio*this.currerntRenderScale;this.fb=[new $(this.gl,l,n),new $(this.gl,l,n)],this.fb.forEach(a=>{a.bind(),t.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA)}),this.historyFrameBuffer=new Array(2).fill(0).map(()=>new $(this.gl,l,n)),this.onResize(l,n)}onTick(e){if(this.tickHandle=0,this.paused)return;const t=e-this.lastTickTime,i=e-this.lastFrameTime;if(this.lastFrameTime=e,t<1e3/this.maxFPS){this.requestTick();return}this.hasLyric&&(this.playTime+=i*this.flowSpeed*.2),this.frameTime+=i,this.onRedraw(this.playTime,i)&&this.staticMode||this.requestTick(),this.lastTickTime=e,this.ampTransition}onResize(e,t){this._targetSize=[Math.round(e),Math.round(t)]}checkResize(){if(this._currentSize[0]===this._targetSize[0]&&this._currentSize[1]===this._targetSize[1])return;this._currentSize=[...this._targetSize];const[e,t]=this._targetSize,i=Math.round(Math.max(e/this.currerntRenderScale,e)),l=Math.round(Math.max(t/this.currerntRenderScale,t));this.renderSize=[e,t],this.canvas.width=i,this.canvas.height=l,this.pixelSize=[i,l],this.gl.viewport(0,0,i,l);for(const n of this.fb)n.resize(e,t);for(const n of this.historyFrameBuffer)n.resize(i,l)}requestTick(){this.tickHandle||(this.tickHandle=requestAnimationFrame(e=>this.onTick(e)))}drawScreen(){this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}bindDefaultFrameBuffer(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}onRedraw(e,t){this.checkResize(),this.hasLyricValue=(this.hasLyricValue*19+(this.hasLyric?1:0))/20;const i=this.gl;this.vertexBuffer.bind(),this.indexBuffer.bind(),this.mainProgram.use(),this.mainProgram.setUniform2f("IIlIlIIlIlIllI",this.renderSize[0],this.renderSize[1]),this.mainProgram.setUniform1f("lIIIlllllIllIl",e/1e3),this.mainProgram.setUniform1f("IIIlllllllIIIllIl",this.hasLyricValue),this.mainProgram.setUniform1f("IIIlllIlIIllll",this.hasLyric?this._lowFreqVolume:0);const[l,n]=this.fb;n.bind(),i.clearColor(0,0,0,0),i.clear(this.gl.COLOR_BUFFER_BIT);for(const a of this.sprites)l.bind(),i.clearColor(0,0,0,0),i.clear(this.gl.COLOR_BUFFER_BIT),this.mainProgram.use(),a.draw("IlllIIlIlllIll"),n.bind(),this.blendProgram.use(),l.active(),this.blendProgram.setUniform1i("src",0),this.blendProgram.setUniform1f("lerp",a.alpha),this.blendProgram.setUniform1f("scale",this.currerntRenderScale),this.drawScreen(),a.alpha=Math.min(1,a.alpha+t/200);if(this.noiseProgram.use(),this.blendProgram.setUniform1i("src",0),this.noiseProgram.setUniform2f("renderSize",this.renderSize[0],this.renderSize[1]),this.noiseProgram.setUniform1f("frameTime",this.frameTime),l.bind(),n.active(),this.bindDefaultFrameBuffer(),this.drawScreen(),this.sprites.length>1&&this.sprites[this.sprites.length-1].alpha>=1)for(const a of this.sprites.splice(0,this.sprites.length-1))a.dispose();return this.sprites.length===1&&this.sprites[0].alpha>=1}copyFrameBuffer(e,t=null){e!==t&&(e.active(this.gl.TEXTURE0),this.copyProgram.use(),t?t.bind():this.bindDefaultFrameBuffer(),this.copyProgram.setUniform1i("src",0),this.drawScreen())}setupGL(){const e=this.canvas.getContext("webgl2",{alpha:!0,depth:!1,powerPreference:"low-power"});if(!e)throw new Error("WebGL2 not supported");return this.gl=e,e.enable(e.BLEND),e.disable(e.DEPTH_TEST),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.getExtension("EXT_color_buffer_float")||console.warn("EXT_color_buffer_float not supported"),e.getExtension("EXT_float_blend")||console.warn("EXT_float_blend not supported"),e.getExtension("OES_texture_float_linear")||console.warn("OES_texture_float_linear not supported"),e}setLowFreqVolume(e){this._lowFreqVolume=e}setStaticMode(e){this.staticMode=e,this.lastFrameTime=performance.now(),this.requestTick()}setFPS(e){this.maxFPS=e}pause(){this.tickHandle&&(cancelAnimationFrame(this.tickHandle),this.tickHandle=0),this.paused=!0}resume(){this.paused=!1,this.requestTick()}loadImage(e){return new Promise((t,i)=>{const l=document.createElement("img");l.onload=()=>t(l),l.onerror=i,l.src=e,l.crossOrigin="anonymous"})}async setAlbumImage(e){if(e.trim().length===0)return;let t=5,i=null;for(;!i&&t>0;)try{i=await this.loadImage(e)}catch(m){console.warn(`failed on loading album image, retrying (${t})`,e,m),t--}if(!i)return;const l=this.reduceImageSizeCanvas,n=l.getContext("2d");if(!n)throw new Error("Failed to create canvas context");n.clearRect(0,0,l.width,l.height);const a=8,o=i.naturalWidth,c=i.naturalHeight;n.drawImage(i,0,0,o,c,0,0,l.width,l.height);const h=n.getImageData(0,0,l.width,l.height);de(h,.8),ce(h,2),Ie(h,a,4);const I=new me(this.gl,this.mainProgram,this.vertexBuffer,this.indexBuffer,h);this.sprites.push(I),this.hasLyric?this.playTime=Math.random()*1e5:this.playTime=0,this.lastFrameTime=performance.now(),this.requestTick()}setHasLyric(e){this.hasLyric=e,this.requestTick()}getElement(){return this.canvas}dispose(){super.dispose(),this.vertexBuffer.dispose(),this.indexBuffer.dispose(),this.sprites.forEach(e=>e.dispose()),this.copyProgram.dispose(),this.blendProgram.dispose(),this.mainProgram.dispose(),this.fb.forEach(e=>e.dispose()),this.historyFrameBuffer.forEach(e=>e.dispose()),this.tickHandle&&(cancelAnimationFrame(this.tickHandle),this.tickHandle=0)}};r(L,"rawVertexBuffer",new Float32Array([-1,-1,1,-1,-1,1,1,1])),r(L,"rawIndexBuffer",new Uint16Array([0,1,2,1,2,3]));let q=L;class G{constructor(s,e){r(this,"element");r(this,"renderer");this.renderer=s,this.element=e,e.style.pointerEvents="none",e.style.zIndex="-1",e.style.contain="strict"}static new(s){const e=document.createElement("canvas");return new G(new s(e),e)}setRenderScale(s){this.renderer.setRenderScale(s)}setFlowSpeed(s){this.renderer.setFlowSpeed(s)}setStaticMode(s){this.renderer.setStaticMode(s)}setFPS(s){this.renderer.setFPS(s)}pause(){this.renderer.pause()}resume(){this.renderer.resume()}setLowFreqVolume(s){this.renderer.setLowFreqVolume(s)}setHasLyric(s){this.renderer.setHasLyric(s)}setAlbumImage(s){return this.renderer.setAlbumImage(s)}getElement(){return this.element}dispose(){this.renderer.dispose(),this.element.remove()}}const pe=(d,s)=>d.size===s.size&&[...d].every(e=>s.has(e));class C{constructor(s=0){r(this,"currentPosition",0);r(this,"targetPosition",0);r(this,"currentTime",0);r(this,"params",{});r(this,"currentSolver");r(this,"getV");r(this,"getV2");r(this,"queueParams");r(this,"queuePosition");this.targetPosition=s,this.currentPosition=this.targetPosition,this.currentSolver=()=>this.targetPosition,this.getV=()=>0,this.getV2=()=>0}resetSolver(){const s=this.getV(this.currentTime);this.currentTime=0,this.currentSolver=ue(this.currentPosition,s,this.targetPosition,0,this.params),this.getV=j(this.currentSolver),this.getV2=j(this.getV)}arrived(){return Math.abs(this.targetPosition-this.currentPosition)<.01&&this.getV(this.currentTime)<.01&&this.getV2(this.currentTime)<.01&&this.queueParams===void 0&&this.queuePosition===void 0}setPosition(s){this.targetPosition=s,this.currentPosition=s,this.currentSolver=()=>this.targetPosition,this.getV=()=>0,this.getV2=()=>0}update(s=0){this.currentTime+=s,this.currentPosition=this.currentSolver(this.currentTime),this.queueParams&&(this.queueParams.time-=s,this.queueParams.time<=0&&this.updateParams({...this.queueParams})),this.queuePosition&&(this.queuePosition.time-=s,this.queuePosition.time<=0&&this.setTargetPosition(this.queuePosition.position)),this.arrived()&&this.setPosition(this.targetPosition)}updateParams(s,e=0){e>0?this.queueParams={...this.queuePosition??{},...s,time:e}:(this.queuePosition=void 0,this.params={...this.params,...s},this.resetSolver())}setTargetPosition(s,e=0){e>0?this.queuePosition={...this.queuePosition??{},position:s,time:e}:(this.queuePosition=void 0,this.targetPosition=s,this.resetSolver())}getCurrentPosition(){return this.currentPosition}}function ue(d,s,e,t=0,i){const l=(i==null?void 0:i.soft)??!1,n=(i==null?void 0:i.stiffness)??100,a=(i==null?void 0:i.damping)??10,o=(i==null?void 0:i.mass)??1,c=e-d;if(l||1<=a/(2*Math.sqrt(n*o))){const h=-Math.sqrt(n/o),I=-h*c-s;return m=>(m-=t,m<0?d:e-(c+m*I)*Math.E**(m*h))}else{const h=Math.sqrt(4*o*n-a**2),I=(a*c-2*o*s)/h,m=.5*h/o,g=-(.5*a)/o;return u=>(u-=t,u<0?d:e-(Math.cos(u*m)*c+Math.sin(u*m)*I)*Math.E**(u*g))}}function fe(d){return s=>(d(s+.001)-d(s-.001))/(2*.001)}function j(d){return fe(d)}class ge{constructor(s){r(this,"element",document.createElement("div"));r(this,"left",0);r(this,"top",0);r(this,"delay",0);r(this,"lineSize",[0,0]);r(this,"lineTransforms",{posX:new C(0),posY:new C(0)});r(this,"lastStyle","");this.lyricPlayer=s,this.element.setAttribute("class",this.lyricPlayer.style.classes.lyricLine),this.rebuildStyle()}measureSize(){return[this.element.clientWidth,this.element.clientHeight]}show(){this.rebuildStyle()}hide(){this.rebuildStyle()}rebuildStyle(){let s=`transform:translate(${this.lineTransforms.posX.getCurrentPosition().toFixed(2)}px,${this.lineTransforms.posY.getCurrentPosition().toFixed(2)}px);`;!this.lyricPlayer.getEnableSpring()&&this.isInSight&&(s+=`transition-delay:${this.delay}ms;`),s!==this.lastStyle&&(this.lastStyle=s,this.element.setAttribute("style",s))}getElement(){return this.element}setTransform(s=this.left,e=this.top,t=!1,i=0){this.left=s,this.top=e,this.delay=i*1e3|0,t||!this.lyricPlayer.getEnableSpring()?(t&&this.element.classList.add(this.lyricPlayer.style.classes.tmpDisableTransition),this.lineTransforms.posX.setPosition(s),this.lineTransforms.posY.setPosition(e),this.lyricPlayer.getEnableSpring()?this.rebuildStyle():this.show(),t&&requestAnimationFrame(()=>{this.element.classList.remove(this.lyricPlayer.style.classes.tmpDisableTransition)})):(this.lineTransforms.posX.setTargetPosition(s,i),this.lineTransforms.posY.setTargetPosition(e,i))}update(s=0){this.lyricPlayer.getEnableSpring()&&(this.lineTransforms.posX.update(s),this.lineTransforms.posY.update(s),this.isInSight?this.show():this.hide())}get isInSight(){const s=this.lineTransforms.posX.getCurrentPosition(),e=this.lineTransforms.posY.getCurrentPosition(),t=s+this.lineSize[0],i=e+this.lineSize[1],l=this.lyricPlayer.size[0],n=this.lyricPlayer.size[1];return!(s>l||e>n||t<0||i<0)}dispose(){this.element.remove()}}function ye(d){const s=2.5949095;return d<.5?Math.pow(2*d,2)*((s+1)*2*d-s)/2:(Math.pow(2*d-2,2)*((s+1)*(d*2-2)+s)+2)/2}const w=(d,s,e)=>Math.max(d,Math.min(s,e));class Te{constructor(s){r(this,"element",document.createElement("div"));r(this,"dot0",document.createElement("span"));r(this,"dot1",document.createElement("span"));r(this,"dot2",document.createElement("span"));r(this,"left",0);r(this,"top",0);r(this,"scale",1);r(this,"playing",!0);r(this,"lastStyle","");r(this,"currentInterlude");r(this,"currentTime",0);r(this,"interludeTime",0);r(this,"targetBreatheDuration",1500);this.lyricPlayer=s,this.element.className=this.lyricPlayer.style.classes.interludeDots,this.element.appendChild(this.dot0),this.element.appendChild(this.dot1),this.element.appendChild(this.dot2)}getElement(){return this.element}setTransform(s=this.left,e=this.top){this.left=s,this.top=e,this.update()}setInterlude(s){this.currentInterlude=s,this.currentTime=(s==null?void 0:s[0])??0}pause(){this.playing=!1}resume(){this.playing=!0}update(s=0){if(!this.playing)return;this.currentTime+=s;let e="";if(e+=`transform:translate(${this.left.toFixed(2)}px, ${this.top.toFixed(2)}px)`,this.currentInterlude){const t=this.currentInterlude[1]-this.currentInterlude[0],i=this.currentTime-this.currentInterlude[0];if(i<=t){const l=t/Math.ceil(t/this.targetBreatheDuration);let n=1,a=1;n*=Math.sin(1.5*Math.PI-i/l*2)/10+1,i<1e3&&(n*=1-Math.pow((1e3-i)/1e3,2)),i<500?a=0:i<1e3&&(a*=(i-500)/500),t-i<750&&(n*=1-ye((750-(t-i))/750/2)),t-i<375&&(a*=w(0,(t-i)/375,1)),n=Math.max(0,n),e+=` scale(${n})`;const o=w(.25,i*3/t*.75,1),c=w(.25,(i-t/3)*3/t*.75,1),h=w(.25,(i-t/3*2)*3/t*.75,1);this.dot0.style.opacity=`${w(0,Math.max(0,a*o),1)}`,this.dot1.style.opacity=`${w(0,Math.max(0,a*c),1)}`,this.dot2.style.opacity=`${w(0,Math.max(0,a*h),1)}`}else e+=" scale(0)",this.dot0.style.opacity="0",this.dot1.style.opacity="0",this.dot2.style.opacity="0"}else e+=" scale(0)",this.dot0.style.opacity="0",this.dot1.style.opacity="0",this.dot2.style.opacity="0";e+=";",this.lastStyle!==e&&(this.element.setAttribute("style",e),this.lastStyle=e)}dispose(){this.element.remove()}}const ve=/^[\p{Unified_Ideograph}\u0800-\u9FFC]+$/u;function Ee(d,s=0,e="rgba(0,0,0,0.85)",t="rgba(0,0,0,0.5)"){const i=2+d+s,l=d/i,n=(1-l)/2;return[`linear-gradient(to right,${e} ${n*100}%,${t} ${(n+l)*100}%)`,l,i]}function Se(d,s){let e=[],t=[];const i=[];for(const l of d){const n=s(l);e.push(n),t.push(l),n.length>0&&n.trim().length===0?(e.pop(),t.pop(),t.length===1?i.push(t[0]):t.length>1&&i.push(t),i.push(l),e=[],t=[]):(!/^\s*[^\s]*\s*$/.test(e.join(""))||ve.test(n))&&(e.pop(),t.pop(),t.length===1?i.push(t[0]):t.length>1&&i.push(t),e=[n],t=[l])}return t.length===1?i.push(t[0]):i.push(t),i}function Y(d){return d.endTime-d.startTime>=1e3&&d.word.length<=7&&d.word.length>1}class be extends MouseEvent{constructor(s,e){super(e.type,e),this.line=s}}class we extends EventTarget{constructor(e,t={words:[],translatedLyric:"",romanLyric:"",startTime:0,endTime:0,isBG:!1,isDuet:!1}){super();r(this,"element",document.createElement("div"));r(this,"left",0);r(this,"top",0);r(this,"scale",1);r(this,"blur",0);r(this,"delay",0);r(this,"splittedWords",[]);r(this,"lineSize",[0,0]);r(this,"lineTransforms",{posX:new C(0),posY:new C(0),scale:new C(1)});r(this,"listenersMap",new Map);r(this,"onMouseEvent",e=>{const t=new be(this,e);for(const i of this.listenersMap.get(e.type)??[])i.call(this,t);if(!this.dispatchEvent(t)||t.defaultPrevented)return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1});r(this,"isEnabled",!1);r(this,"_hide",!0);r(this,"_prevParentEl",null);r(this,"lastStyle","");this.lyricPlayer=e,this.lyricLine=t,this._prevParentEl=e.getElement(),this.element.setAttribute("class",this.lyricPlayer.style.classes.lyricLine),this.lyricLine.isBG&&this.element.classList.add(this.lyricPlayer.style.classes.lyricBgLine),this.lyricLine.isDuet&&this.element.classList.add(this.lyricPlayer.style.classes.lyricDuetLine),this.element.appendChild(document.createElement("div")),this.element.appendChild(document.createElement("div")),this.element.appendChild(document.createElement("div"));const i=this.element.children[0],l=this.element.children[1],n=this.element.children[2];i.setAttribute("class",this.lyricPlayer.style.classes.lyricMainLine),l.setAttribute("class",this.lyricPlayer.style.classes.lyricSubLine),n.setAttribute("class",this.lyricPlayer.style.classes.lyricSubLine),this.rebuildElement(),this.rebuildStyle()}addMouseEventListener(e,t,i){if(t){const l=this.listenersMap.get(e)??new Set;l.size===0&&this.element.addEventListener(e,this.onMouseEvent),l.add(t),this.listenersMap.set(e,l)}}removeMouseEventListener(e,t,i){if(t){const l=this.listenersMap.get(e);l&&(l.delete(t),l.size===0&&this.element.removeEventListener(e,this.onMouseEvent))}}enable(){this.isEnabled=!0,this.element.classList.add("active");const e=this.element.children[0];this.splittedWords.forEach(t=>{t.elementAnimations.forEach(i=>{i.currentTime=0,i.playbackRate=1,i.play()})}),e.classList.add("active")}measureSize(){this._hide&&(this._prevParentEl&&this._prevParentEl.appendChild(this.element),this.element.style.display="",this.element.style.visibility="hidden");const e=[this.element.clientWidth,this.element.clientHeight];return this._hide&&(this._prevParentEl&&this.element.remove(),this.element.style.display="none",this.element.style.visibility=""),e}disable(){this.isEnabled=!1,this.element.classList.remove("active");const e=this.element.children[0];this.splittedWords.forEach(t=>{t.elementAnimations.forEach(i=>{i.id==="float-word"&&(i.playbackRate=-1,i.play())})}),e.classList.remove("active")}setLine(e){this.lyricLine=e,this.lyricLine.isBG?this.element.classList.add(this.lyricPlayer.style.classes.lyricBgLine):this.element.classList.remove(this.lyricPlayer.style.classes.lyricBgLine),this.lyricLine.isDuet?this.element.classList.add(this.lyricPlayer.style.classes.lyricDuetLine):this.element.classList.remove(this.lyricPlayer.style.classes.lyricDuetLine),this.rebuildElement(),this.rebuildStyle()}getLine(){return this.lyricLine}show(){this._hide=!1,this._prevParentEl&&(this._prevParentEl.appendChild(this.element),this._prevParentEl=null),this.rebuildStyle()}hide(){this._hide=!0,this.element.parentElement&&(this._prevParentEl=this.element.parentElement,this.element.remove()),this.rebuildStyle()}rebuildStyle(){if(this._hide){this.lastStyle!=="display:none;transform:translate(0,-10000px);"&&(this.lastStyle="display:none;transform:translate(0,-10000px);",this.element.setAttribute("style","display:none;transform:translate(0,-10000px);"));return}let e=`transform:translate(${this.lineTransforms.posX.getCurrentPosition().toFixed(1)}px,${this.lineTransforms.posY.getCurrentPosition().toFixed(1)}px) scale(${this.lineTransforms.scale.getCurrentPosition().toFixed(4)});`;!this.lyricPlayer.getEnableSpring()&&this.isInSight&&(e+=`transition-delay:${this.delay}ms;`),e+=`filter:blur(${Math.min(32,this.blur)}px);`,e!==this.lastStyle&&(this.lastStyle=e,this.element.setAttribute("style",e))}rebuildElement(){const e=this.element.children[0],t=this.element.children[1],i=this.element.children[2];if(this.lyricPlayer._getIsNonDynamic()){e.innerText=this.lyricLine.words.map(n=>n.word).join(""),t.innerText=this.lyricLine.translatedLyric,i.innerText=this.lyricLine.romanLyric;return}const l=Se(this.lyricLine.words,n=>n.word);e.innerHTML="",this.splittedWords=[];for(const n of l)if(n instanceof Array){const a=n.map(h=>Y(h)).reduce((h,I)=>h||I,!1),o=n.reduce((h,I)=>(h.endTime=Math.max(h.endTime,I.endTime),h.startTime=Math.min(h.startTime,I.startTime),h.word+=I.word,h),{word:"",startTime:1/0,endTime:-1/0}),c=document.createElement("span");c.classList.add("emphasize-wrapper");for(const h of n){const I=document.createElement("span"),m=this.initFloatAnimation(o,I);if(a){I.classList.add("emphasize");const g=[];for(const y of h.word.trim().split("")){const p=document.createElement("span");p.innerText=y,g.push(p),I.appendChild(p)}const u={...h,mainElement:I,subElements:g,elementAnimations:[],width:0,height:0,shouldEmphasize:a};u.elementAnimations.push(...this.initEmphasizeAnimation(u)),this.splittedWords.push(u)}else I.innerText=h.word,this.splittedWords.push({...h,mainElement:I,subElements:[],elementAnimations:[m],width:0,height:0,shouldEmphasize:a});c.appendChild(I)}o.word.trimStart()!==o.word&&e.appendChild(document.createTextNode(" ")),e.appendChild(c),o.word.trimEnd()!==o.word&&e.appendChild(document.createTextNode(" "))}else if(n.word.trim().length===0)e.appendChild(document.createTextNode(" "));else{const a=Y(n),o=document.createElement("span"),c={...n,mainElement:o,subElements:[],elementAnimations:[this.initFloatAnimation(n,o)],width:0,height:0,shouldEmphasize:a};if(a){o.classList.add("emphasize");const h=[];for(const I of n.word.trim().split("")){const m=document.createElement("span");m.innerText=I,h.push(m),o.appendChild(m)}c.subElements=h,c.elementAnimations.push(...this.initEmphasizeAnimation(c))}else o.innerText=n.word.trim();n.word.trimStart()!==n.word&&e.appendChild(document.createTextNode(" ")),e.appendChild(o),n.word.trimEnd()!==n.word&&e.appendChild(document.createTextNode(" ")),this.splittedWords.push(c)}t.innerText=this.lyricLine.translatedLyric,i.innerText=this.lyricLine.romanLyric}initFloatAnimation(e,t){const i=e.startTime-this.lyricLine.startTime,l=Math.max(1e3,e.endTime-e.startTime),n=t.animate([{transform:"translateY(0px)"},{transform:"translateY(-0.03em)"}],{duration:isFinite(l)?l:0,delay:isFinite(i)?i:0,id:"float-word",composite:"add",fill:"both",easing:"ease-in"});return n.pause(),n}initEmphasizeAnimation(e){const t=e.startTime-this.lyricLine.startTime,i=e.endTime-e.startTime;return e.subElements.map((l,n,a)=>{const o=Math.max(1e3,e.endTime-e.startTime),c=t+i/2/a.length*n;let h=0,I=0;o>=1500&&o<3e3?(h=1,I=.2):o>=3e3&&o<4e3?(h=1.5,I=.3):o>=4e3&&o<4500?(h=2,I=.4):o>=4500&&(h=3,I=.4);const m=l.animate([{offset:0,textShadow:"rgba(255, 255, 255, 0) 0 0 0.15em"},{offset:.1,transform:`translateZ(${h}vw) translateY(-0.03em)`,textShadow:`rgba(255, 255, 255, ${I*.5}) 0 0 0.15em`},{offset:.2,textShadow:`rgba(255, 255, 255, ${I}) 0 0 0.2em`},{offset:.5,textShadow:`rgba(255, 255, 255, ${I}) 0 0 0.2em`},{offset:.7,textShadow:`rgba(255, 255, 255, ${I*.75}) 0 0 0.2em`},{offset:1,transform:"translateZ(0vw)",textShadow:"rgba(255, 255, 255, 0.0) 0 0 0.2em"}],{duration:isFinite(o)?o:0,delay:isFinite(c)?c:0,id:"glow-word",iterations:1,composite:"replace",easing:"ease-in",fill:"both"});return m.pause(),m})}updateMaskImage(){this._hide&&(this._prevParentEl&&this._prevParentEl.appendChild(this.element),this.element.style.display="",this.element.style.visibility="hidden"),this.splittedWords.forEach((e,t)=>{const i=e.mainElement;if(console.log(e.startTime+" "+this.getLine().startTime),i){parseFloat(getComputedStyle(i).paddingInline),e.width=i.clientWidth,e.height=i.clientHeight;const l=e.height/2,[n,a,o]=Ee(l/e.width,0,"rgba(0,0,0,0.85)","rgba(0,0,0,0.25)"),c=`${o*100}% 100%`;this.lyricPlayer.supportMaskImage?(i.style.maskImage=n,i.style.maskRepeat="no-repeat",i.style.maskOrigin="left",i.style.maskSize=c):(i.style.webkitMaskImage=n,i.style.webkitMaskRepeat="no-repeat",i.style.webkitMaskOrigin="left",i.style.webkitMaskSize=c);const h=e.width+l,I=`clamp(${-h}px,calc(${-h}px + (var(--amll-player-time) - ${e.startTime})*${h/Math.max(1,Math.abs(e.endTime-e.startTime))}px),0px) 0px, left top`;i.style.maskPosition=I,i.style.webkitMaskPosition=I}}),this._hide&&(this._prevParentEl&&this.element.remove(),this.element.style.display="none",this.element.style.visibility="")}getElement(){return this.element}setTransform(e=this.left,t=this.top,i=this.scale,l=1,n=0,a=!1,o=0){const c=Math.round(n),h=this.isInSight,I=this.lyricPlayer.getEnableSpring();this.left=e,this.top=t,this.scale=i,this.delay=o*1e3|0;const m=this.element.children[0],g=this.element.children[1],u=this.element.children[2];if(m.style.opacity=`${l}`,g.style.opacity=`${l/2}`,u.style.opacity=`${l/2}`,a||!I){if(this.blur=Math.min(32,c),a&&this.element.classList.add(this.lyricPlayer.style.classes.tmpDisableTransition),this.lineTransforms.posX.setPosition(e),this.lineTransforms.posY.setPosition(t),this.lineTransforms.scale.setPosition(i),I)this.rebuildStyle();else{const y=this.isInSight;h||y?this.show():this.hide()}a&&requestAnimationFrame(()=>{this.element.classList.remove(this.lyricPlayer.style.classes.tmpDisableTransition)})}else this.lineTransforms.posX.setTargetPosition(e,o),this.lineTransforms.posY.setTargetPosition(t,o),this.lineTransforms.scale.setTargetPosition(i),this.blur!==Math.min(32,c)&&(this.blur=Math.min(32,c),this.element.style.filter=`blur(${Math.min(32,c)}px)`)}update(e=0){this.lyricPlayer.getEnableSpring()&&(this.lineTransforms.posX.update(e),this.lineTransforms.posY.update(e),this.lineTransforms.scale.update(e),this.isInSight?this.show():this.hide())}_getDebugTargetPos(){return`[\u4F4D\u79FB: ${this.left}, ${this.top}; \u7F29\u653E: ${this.scale}; \u5EF6\u65F6: ${this.delay}]`}get isInSight(){const e=this.lineTransforms.posX.getCurrentPosition(),t=this.lineTransforms.posY.getCurrentPosition(),i=e+this.lineSize[0],l=t+this.lineSize[1],n=this.lyricPlayer.size[0],a=this.lyricPlayer.size[1];return!(e>n||i<0||t>a||l<0)}dispose(){this.element.remove()}}const xe=te(ie());class Le extends MouseEvent{constructor(s,e,t){super(`line-${t.type}`,t),this.lineIndex=s,this.line=e}}class Pe extends EventTarget{constructor(){super();r(this,"element",document.createElement("div"));r(this,"currentTime",0);r(this,"lyricLines",[]);r(this,"processedLines",[]);r(this,"lyricLinesEl",[]);r(this,"lyricLinesSize",new WeakMap);r(this,"lyricLinesIndexes",new WeakMap);r(this,"hotLines",new Set);r(this,"bufferedLines",new Set);r(this,"scrollToIndex",0);r(this,"allowScroll",!0);r(this,"scrolledHandler",0);r(this,"isScrolled",!1);r(this,"invokedByScrollEvent",!1);r(this,"scrollOffset",0);r(this,"hidePassedLines",!1);r(this,"resizeObserver",new ResizeObserver(e=>{const t=e[0].contentRect;this.size[0]=t.width,this.size[1]=t.height;const i=getComputedStyle(e[0].target),l=this.element.clientWidth-parseFloat(i.paddingLeft)-parseFloat(i.paddingRight),n=this.element.clientHeight-parseFloat(i.paddingTop)-parseFloat(i.paddingBottom);this.innerSize[0]=l,this.innerSize[1]=n,this.rebuildStyle(),this.calcLayout(!0,!0),this.lyricLinesEl.forEach(a=>a.updateMaskImage())}));r(this,"posXSpringParams",{mass:1,damping:10,stiffness:100});r(this,"posYSpringParams",{mass:1,damping:16.5,stiffness:100});r(this,"scaleSpringParams",{mass:1,damping:20,stiffness:100});r(this,"emUnit",Math.max(Math.min(innerHeight*.05,innerWidth*.1),12));r(this,"padding",this.emUnit);r(this,"enableBlur",!0);r(this,"enableScale",!0);r(this,"interludeDots");r(this,"interludeDotsSize",[0,0]);r(this,"bottomLine");r(this,"supportPlusLighter",CSS.supports("mix-blend-mode","plus-lighter"));r(this,"supportMaskImage",CSS.supports("mask-image","none"));r(this,"disableSpring",!1);r(this,"alignAnchor","center");r(this,"alignPosition",.5);r(this,"isNonDynamic",!1);r(this,"scrollBoundary",[0,0]);r(this,"size",[0,0]);r(this,"innerSize",[0,0]);r(this,"onLineClickedHandler",e=>{const t=new Le(this.lyricLinesIndexes.get(e.line)??-1,e.line,e);this.dispatchEvent(t)||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation())});r(this,"style",xe.createStyleSheet({lyricPlayer:{userSelect:"none",fontSize:"var(--amll-lyric-player-font-size,max(min(5vh, 10vw), 12px))",padding:"1em",margin:"-1em",width:"100%",height:"100%",overflow:"hidden",boxSizing:"content-box",maxWidth:"100%",maxHeight:"100%",zIndex:1,color:"var(--amll-lyric-view-color,white)",mixBlendMode:"plus-lighter",contain:"strict","&:hover":{"& $lyricLine":{filter:"unset !important"}}},lyricLine:{position:"absolute",backfaceVisibility:"hidden",transformOrigin:"left",width:"var(--amll-lyric-player-width,100%)",height:"fit-content",padding:"2vh 1.05em",margin:"0 -1em",contain:"content",willChange:"filter,transform,opacity",transition:"filter 0.25s, background-color 0.25s, box-shadow 0.25s",boxSizing:"content-box",borderRadius:"8px","&:has(>*):hover":{backgroundColor:"var(--amll-lyric-view-hover-bg-color,#fff1)",boxShadow:"0 0 0 8px var(--amll-lyric-view-hover-bg-color,#fff1)"},"&:has(>*):active":{boxShadow:"0 0 0 4px var(--amll-lyric-view-hover-bg-color,#fff1)"}},"@media (max-width: 1024px)":{lyricLine:{padding:"1vh 1em"}},lyricDuetLine:{textAlign:"right",transformOrigin:"right"},lyricBgLine:{opacity:0,fontSize:"max(50%, 10px)",transition:"opacity 0.25s","&.active":{transition:"opacity 0.25s 0.25s",opacity:.4}},lyricMainLine:{transition:"opacity 0.3s 0.25s",willChange:"opacity",margin:"-1em",padding:"1em","& span":{display:"inline-block"},"& > span, span.emphasize-wrapper":{whiteSpace:"pre-wrap",maxLines:"1",willChange:"transform,display,mask-image","&.emphasize, span.emphasize":{transformStyle:"preserve-3d",perspective:"min(50vw, 50vh)",padding:"1em",margin:"-1em","& > span":{padding:"1em",margin:"-1em"}}}},lyricSubLine:{fontSize:"max(0.5em, 10px)",transition:"opacity 0.3s 0.25s",opacity:.3},disableSpring:{"& > *":{transition:"filter 0.25s, transform 0.5s, background-color 0.25s, box-shadow 0.25s"}},interludeDots:{height:"clamp(0.5em,1vh,3em)",transformOrigin:"center",width:"fit-content",padding:"2.5% 0",position:"absolute",display:"flex",gap:"0.25em",left:"1em","& > *":{height:"clamp(0.5em,1vh,3em)",display:"inline-block",borderRadius:"50%",aspectRatio:"1 / 1",backgroundColor:"var(--amll-lyric-view-color,white)",marginRight:"4px"},"&.duet":{right:"1em",transformOrigin:"center"}},"@supports (mix-blend-mode: plus-lighter)":{lyricSubLine:{opacity:.3}},tmpDisableTransition:{transition:"none !important"}}));r(this,"onPageShow",()=>{this.calcLayout(!0,!0)});this.interludeDots=new Te(this),this.bottomLine=new ge(this),this.element.setAttribute("class",this.style.classes.lyricPlayer),this.disableSpring&&this.element.classList.add(this.style.classes.disableSpring),this.rebuildStyle(),this.resizeObserver.observe(this.element),this.element.appendChild(this.interludeDots.getElement()),this.element.appendChild(this.bottomLine.getElement()),this.style.attach(),this.interludeDots.setTransform(0,200),window.addEventListener("pageshow",this.onPageShow);let e=0,t="none",i=0,l=0,n=0,a=Symbol("amll-scroll"),o=0,c=0;this.element.addEventListener("touchstart",h=>{this.beginScrollHandler()&&(h.preventDefault(),e=this.scrollOffset,i=h.touches[0].screenY,o=i,l=Date.now(),n=0)}),this.element.addEventListener("touchmove",h=>{if(this.beginScrollHandler()){h.preventDefault();const I=h.touches[0].screenY,m=I-i,g=I-o,u=g>0?"down":g<0?"up":"none";t!==u?(t=u,e=this.scrollOffset,i=I,l=Date.now()):this.scrollOffset=e-m,o=I,c=Date.now(),this.limitScrollOffset(),this.calcLayout(!0)}}),this.element.addEventListener("touchend",h=>{if(this.beginScrollHandler()){h.preventDefault(),i=0;const I=Date.now();if(I-c>100)return this.endScrollHandler();const m=I-l;n=(this.scrollOffset-e)/m*1e3;let g=0;const u=Symbol("amll-scroll");a=u;const y=p=>{g||(g=p),a===u&&this.beginScrollHandler()&&(this.scrollOffset+=n*(p-g)/1e3,n*=.99,this.limitScrollOffset(),this.calcLayout(!0),Math.abs(n)>1&&!this.scrollBoundary.includes(this.scrollOffset)&&requestAnimationFrame(y),this.endScrollHandler(),g=p)};requestAnimationFrame(y),this.endScrollHandler()}}),this.element.addEventListener("wheel",h=>{this.beginScrollHandler()&&(h.deltaMode===h.DOM_DELTA_PIXEL?(this.scrollOffset+=h.deltaY,this.limitScrollOffset(),this.calcLayout(!0)):(this.scrollOffset+=h.deltaY*50,this.limitScrollOffset(),this.calcLayout(!1)),this.endScrollHandler())})}_getIsNonDynamic(){return this.isNonDynamic}setEnableSpring(e=!0){this.disableSpring=!e,e?this.element.classList.remove(this.style.classes.disableSpring):this.element.classList.add(this.style.classes.disableSpring),this.calcLayout(!0)}getEnableSpring(){return!this.disableSpring}setEnableScale(e=!0){this.enableScale=e,this.calcLayout()}getEnableScale(){return this.enableScale}beginScrollHandler(){const e=this.allowScroll;return e&&(this.isScrolled=!0,this.invokedByScrollEvent=!0,clearTimeout(this.scrolledHandler),this.scrolledHandler=setTimeout(()=>{this.isScrolled=!1,this.scrollOffset=0},5e3)),e}endScrollHandler(){this.invokedByScrollEvent=!1}limitScrollOffset(){this.scrollOffset=Math.max(Math.min(this.scrollBoundary[1],this.scrollOffset),this.scrollBoundary[0])}getCurrentInterlude(){var i,l,n;if(this.bufferedLines.size>0)return;const e=this.currentTime+20,t=this.scrollToIndex;if(t===0){if((i=this.processedLines[0])!=null&&i.startTime&&this.processedLines[0].startTime>e)return[e,Math.max(e,this.processedLines[0].startTime-250),-2,this.processedLines[0].isDuet]}else if((l=this.processedLines[t])!=null&&l.endTime&&((n=this.processedLines[t+1])!=null&&n.startTime)&&this.processedLines[t+1].startTime>e&&this.processedLines[t].endTime<e)return[Math.max(this.processedLines[t].endTime,e),this.processedLines[t+1].startTime,t,this.processedLines[t+1].isDuet]}rebuildStyle(){let e="";e+="--amll-lyric-player-width:",e+=this.innerSize[0]-this.padding*2,e+="px;",e+="--amll-lyric-player-height:",e+=this.innerSize[1]-this.padding*2,e+="px;",this.element.setAttribute("style",e)}setHidePassedLines(e){this.hidePassedLines=e,this.calcLayout()}setEnableBlur(e){this.enableBlur!==e&&(this.enableBlur=e,this.calcLayout())}setLyricLines(e){e.forEach(i=>{i.words.forEach(l=>{l.word=l.word.replace(/\s+/g," ")})}),this.lyricLines=e;const t=750;this.processedLines=e.filter(i=>i.words.reduce((l,n)=>l+n.word.trim().length,0)>0).map((i,l,n)=>{if(i.isBG)return{...i};if(l===0)return{...i,startTime:Math.max(i.startTime-t,0)};{const a=n[l-1],o=n[l-2];if(a!=null&&a.isBG&&o){if(o.endTime<i.startTime)return{...i,startTime:Math.max(o.endTime,i.startTime-t)||i.startTime}}else if(a!=null&&a.endTime&&a.endTime<i.startTime)return{...i,startTime:Math.max(a==null?void 0:a.endTime,i.startTime-t)||i.startTime};return{...i}}}),this.isNonDynamic=!0;for(const i of this.processedLines)if(i.words.length>1){this.isNonDynamic=!1;break}this.processedLines.forEach((i,l,n)=>{const a=n[l+1],o=i.words[i.words.length-1];o&&Y(o)&&(a?a.startTime>i.endTime&&(i.endTime=Math.min(i.endTime+1500,a.startTime)):i.endTime=i.endTime+1500)}),this.processedLines.forEach((i,l,n)=>{if(i.isBG)return;const a=n[l+1];a!=null&&a.isBG&&(a.startTime=Math.min(a.startTime,i.startTime))}),this.lyricLinesEl.forEach(i=>{i.removeMouseEventListener("click",this.onLineClickedHandler),i.removeMouseEventListener("contextmenu",this.onLineClickedHandler),i.dispose()}),this.lyricLinesEl=this.processedLines.map(i=>{const l=new we(this,i);return l.addMouseEventListener("click",this.onLineClickedHandler),l.addMouseEventListener("contextmenu",this.onLineClickedHandler),l}),this.lyricLinesEl.forEach((i,l)=>{this.element.appendChild(i.getElement()),this.lyricLinesIndexes.set(i,l),i.updateMaskImage()}),this.interludeDots.setInterlude(void 0),this.hotLines.clear(),this.bufferedLines.clear(),this.setLinePosXSpringParams({}),this.setLinePosYSpringParams({}),this.setLineScaleSpringParams({}),this.setCurrentTime(0,!0),this.calcLayout(!0,!0)}resetScroll(){this.isScrolled=!1,this.scrollOffset=0,this.invokedByScrollEvent=!1,clearTimeout(this.scrolledHandler),this.scrolledHandler=0}calcLayout(e=!1,t=!1){var y;t&&(this.emUnit=parseFloat(getComputedStyle(this.element).fontSize),this.lyricLinesEl.forEach(p=>{const f=p.measureSize();this.lyricLinesSize.set(p,f),p.lineSize=f}),this.interludeDotsSize[0]=this.interludeDots.getElement().clientWidth,this.interludeDotsSize[1]=this.interludeDots.getElement().clientHeight,this.bottomLine.lineSize=this.bottomLine.measureSize());const i=this.getCurrentInterlude();let l=-this.scrollOffset,n=this.scrollToIndex,a=0;i?(a=i[1]-i[0],a>=5e3&&this.lyricLinesEl[i[2]+1]&&(n=i[2]+1)):this.interludeDots.setInterlude(void 0);const o=this.enableScale?.95:1,c=this.lyricLinesEl.slice(0,n).reduce((p,f)=>{var T;return p+(f.getLine().isBG?0:((T=this.lyricLinesSize.get(f))==null?void 0:T[1])??0)},0);this.scrollBoundary[0]=-c,l-=c,l+=this.size[1]*this.alignPosition;const h=this.lyricLinesEl[n];if(h){const p=((y=this.lyricLinesSize.get(h))==null?void 0:y[1])??0;switch(this.alignAnchor){case"bottom":l-=p;break;case"center":l-=p/2;break}}const I=Math.max(...this.bufferedLines);let m=0,g=.05,u=!1;this.lyricLinesEl.forEach((p,f)=>{var A,v,D;const T=this.bufferedLines.has(f),b=T||f>=this.scrollToIndex&&f<I,x=p.getLine();x.isDuet&&this.size[0]-(((A=this.lyricLinesSize.get(p))==null?void 0:A[0])??0),!u&&a>=5e3&&(f===this.scrollToIndex&&(i==null?void 0:i[2])===-2||f===this.scrollToIndex+1)&&(u=!0,this.interludeDots.setTransform(this.padding,l+12),i&&this.interludeDots.setInterlude([i[0],i[1]]),l+=this.interludeDotsSize[1]+40);const E=this.hidePassedLines&&f<(i?i[2]+1:this.scrollToIndex)?0:T?1:1/3;p.setTransform(this.padding,l,b?1:o,E,!this.invokedByScrollEvent&&this.enableBlur?b?0:1+(f<this.scrollToIndex?Math.abs(this.scrollToIndex-f):Math.abs(f-Math.max(this.scrollToIndex,I))):0,e,m),x.isBG&&b?l+=((v=this.lyricLinesSize.get(p))==null?void 0:v[1])??0:x.isBG||(l+=((D=this.lyricLinesSize.get(p))==null?void 0:D[1])??0),l>=0&&(m+=g,g/=1.2)}),this.scrollBoundary[1]=l+this.scrollOffset-this.size[1]/2,this.bottomLine.setTransform(this.padding,l,e,m)}getCurrentTime(){return this.currentTime}getLyricLines(){return this.lyricLines}getElement(){return this.element}getBottomLineElement(){return this.bottomLine.getElement()}setAlignAnchor(e){this.alignAnchor=e}setAlignPosition(e){this.alignPosition=e}setCurrentTime(e,t=!1){if(this.currentTime=e,this._getIsNonDynamic()||this.element.style.setProperty("--amll-player-time",`${e}`),this.isScrolled)return;const i=new Set,l=new Set,n=new Set;this.hotLines.forEach(a=>{const o=this.processedLines[a];if(o){if(o.isBG)return;const c=this.processedLines[a+1];if(c!=null&&c.isBG){const h=this.processedLines[a+2],I=Math.min(o.startTime,c==null?void 0:c.startTime),m=Math.min(Math.max(o.endTime,(h==null?void 0:h.startTime)??Number.MAX_VALUE),Math.max(o.endTime,c==null?void 0:c.endTime));(I>e||m<=e)&&(this.hotLines.delete(a),i.add(a),this.hotLines.delete(a+1),i.add(a+1),t&&(this.lyricLinesEl[a].disable(),this.lyricLinesEl[a+1].disable()))}else(o.startTime>e||o.endTime<=e)&&(this.hotLines.delete(a),i.add(a),t&&this.lyricLinesEl[a].disable())}else this.hotLines.delete(a),i.add(a),t&&this.lyricLinesEl[a].disable()}),this.processedLines.forEach((a,o,c)=>{var h;!a.isBG&&a.startTime<=e&&a.endTime>e&&(this.hotLines.has(o)||(this.hotLines.add(o),n.add(o),t&&this.lyricLinesEl[o].enable(),(h=c[o+1])!=null&&h.isBG&&(this.hotLines.add(o+1),n.add(o+1),t&&this.lyricLinesEl[o+1].enable())))}),this.bufferedLines.forEach(a=>{this.hotLines.has(a)||(l.add(a),t&&this.lyricLinesEl[a].disable())}),t?(this.bufferedLines.size>0?this.scrollToIndex=Math.min(...this.bufferedLines):this.scrollToIndex=this.processedLines.findIndex(a=>a.startTime>=e),this.bufferedLines.clear(),this.hotLines.forEach(a=>this.bufferedLines.add(a)),this.calcLayout(!0)):(l.size>0||n.size>0)&&(l.size===0&&n.size>0?(n.forEach(a=>{this.bufferedLines.add(a),this.lyricLinesEl[a].enable()}),this.scrollToIndex=Math.min(...this.bufferedLines),this.calcLayout()):n.size===0&&l.size>0?pe(l,this.bufferedLines)&&(this.bufferedLines.forEach(a=>{this.hotLines.has(a)||(this.bufferedLines.delete(a),this.lyricLinesEl[a].disable())}),this.calcLayout()):(n.forEach(a=>{this.bufferedLines.add(a),this.lyricLinesEl[a].enable()}),l.forEach(a=>{this.bufferedLines.delete(a),this.lyricLinesEl[a].disable()}),this.bufferedLines.size>0&&(this.scrollToIndex=Math.min(...this.bufferedLines)),this.calcLayout()))}pause(){this.interludeDots.pause()}resume(){this.interludeDots.resume()}update(e=0){const t=e/1e3;this.interludeDots.update(e),this.bottomLine.update(t),this.lyricLinesEl.forEach(i=>i.update(t))}setLinePosXSpringParams(e){this.posXSpringParams={...this.posXSpringParams,...e},this.bottomLine.lineTransforms.posX.updateParams(this.posXSpringParams),this.lyricLinesEl.forEach(t=>t.lineTransforms.posX.updateParams(this.posXSpringParams))}setLinePosYSpringParams(e){this.posYSpringParams={...this.posYSpringParams,...e},this.bottomLine.lineTransforms.posY.updateParams(this.posYSpringParams),this.lyricLinesEl.forEach(t=>t.lineTransforms.posY.updateParams(this.posYSpringParams))}setLineScaleSpringParams(e){this.scaleSpringParams={...this.scaleSpringParams,...e},this.lyricLinesEl.forEach(t=>t.lineTransforms.scale.updateParams(this.scaleSpringParams))}dispose(){this.element.remove(),this.resizeObserver.disconnect(),this.style.detach(),this.lyricLinesEl.forEach(e=>e.dispose()),window.removeEventListener("pageshow",this.onPageShow),this.bottomLine.dispose(),this.interludeDots.dispose()}}export{V as AbstractBaseRenderer,G as BackgroundRender,N as BaseRenderer,q as EplorRenderer,Pe as LyricPlayer,le as PixiRenderer};
