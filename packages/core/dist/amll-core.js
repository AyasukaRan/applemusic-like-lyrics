"use strict";var b=Object.defineProperty;var S=(c,t,e)=>t in c?b(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var a=(c,t,e)=>(S(c,typeof t!="symbol"?t+"":t,e),e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const P=require("@pixi/display"),E=require("@pixi/app"),f=require("@pixi/filter-blur"),L=require("@pixi/filter-color-matrix"),w=require("@pixi/core"),g=require("@pixi/sprite"),x=require("jss"),v=require("jss-preset-default");class C extends P.Container{constructor(){super(...arguments);a(this,"time",0)}}class M{constructor(t){a(this,"observer");a(this,"app");a(this,"curContainer");a(this,"lastContainer",new Set);a(this,"onTick",t=>{for(const e of this.lastContainer)e.alpha=Math.max(0,e.alpha-t/60),e.alpha<=0&&(this.app.stage.removeChild(e),this.lastContainer.delete(e));if(this.curContainer){this.curContainer.alpha=Math.min(1,this.curContainer.alpha+t/60);const[e,s,r,n]=this.curContainer.children,l=Math.max(this.app.screen.width,this.app.screen.height);e.position.set(this.app.screen.width/2,this.app.screen.height/2),s.position.set(this.app.screen.width/2.5,this.app.screen.height/2.5),r.position.set(this.app.screen.width/2,this.app.screen.height/2),n.position.set(this.app.screen.width/2,this.app.screen.height/2),e.width=l*Math.sqrt(2),e.height=e.width,s.width=l*.8,s.height=s.width,r.width=l*.5,r.height=r.width,n.width=l*.25,n.height=n.width,this.curContainer.time+=t*this.flowSpeed,e.rotation+=t/1e3*this.flowSpeed,s.rotation-=t/500*this.flowSpeed,r.rotation+=t/1e3*this.flowSpeed,n.rotation-=t/750*this.flowSpeed,r.x=this.app.screen.width/2+this.app.screen.width/4*Math.cos(this.curContainer.time/1e3*.75),r.y=this.app.screen.height/2+this.app.screen.width/4*Math.cos(this.curContainer.time/1e3*.75),n.x=this.app.screen.width/2+this.app.screen.width/4*.1+Math.cos(this.curContainer.time*.006*.75),n.y=this.app.screen.height/2+this.app.screen.width/4*.1+Math.cos(this.curContainer.time*.006*.75)}});a(this,"flowSpeed",2);a(this,"currerntRenderScale",.75);this.canvas=t;const e=t.getBoundingClientRect();this.canvas.width=e.width*this.currerntRenderScale,this.canvas.height=e.height*this.currerntRenderScale,this.observer=new ResizeObserver(()=>{const s=t.getBoundingClientRect();this.canvas.width=Math.max(1,s.width),this.canvas.height=Math.max(1,s.height),this.app.renderer.resize(this.canvas.width*this.currerntRenderScale,this.canvas.height*this.currerntRenderScale),this.rebuildFilters()}),this.observer.observe(t),this.app=new E.Application({view:t,resizeTo:this.canvas,powerPreference:"low-power",backgroundAlpha:0}),this.rebuildFilters(),this.app.ticker.add(this.onTick),this.app.ticker.start()}setRenderScale(t){this.currerntRenderScale=t;const e=this.canvas.getBoundingClientRect();this.canvas.width=Math.max(1,e.width),this.canvas.height=Math.max(1,e.height),this.app.renderer.resize(this.canvas.width*this.currerntRenderScale,this.canvas.height*this.currerntRenderScale),this.rebuildFilters()}rebuildFilters(){const t=Math.min(this.canvas.width,this.canvas.height),e=new L.ColorMatrixFilter;e.saturate(1.2,!1);const s=new L.ColorMatrixFilter;s.brightness(.6,!1);const r=new L.ColorMatrixFilter;r.contrast(.3,!0),this.app.stage.filters=[],this.app.stage.filters.push(new f.BlurFilter(5,1)),this.app.stage.filters.push(new f.BlurFilter(10,1)),this.app.stage.filters.push(new f.BlurFilter(20,2)),this.app.stage.filters.push(new f.BlurFilter(40,2)),t>512&&this.app.stage.filters.push(new f.BlurFilter(80,2)),t>768&&this.app.stage.filters.push(new f.BlurFilter(160,4)),t>768*2&&this.app.stage.filters.push(new f.BlurFilter(320,4)),this.app.stage.filters.push(e,s,r),this.app.stage.filters.push(new f.BlurFilter(5,1))}setFPS(t){this.app.ticker.maxFPS=t}pause(){this.app.ticker.stop(),this.app.render()}resume(){this.app.ticker.start()}async setAlbumImage(t){const e=await w.Texture.fromURL(t),s=new C,r=new g.Sprite(e),n=new g.Sprite(e),l=new g.Sprite(e),i=new g.Sprite(e);r.anchor.set(.5,.5),n.anchor.set(.5,.5),l.anchor.set(.5,.5),i.anchor.set(.5,.5),r.rotation=Math.random()*Math.PI*2,n.rotation=Math.random()*Math.PI*2,l.rotation=Math.random()*Math.PI*2,i.rotation=Math.random()*Math.PI*2,s.addChild(r,n,l,i),this.curContainer&&this.lastContainer.add(this.curContainer),this.curContainer=s,this.app.stage.addChild(this.curContainer),this.curContainer.alpha=0}dispose(){this.observer.disconnect(),this.app.ticker.remove(this.onTick)}}class z extends M{constructor(){const e=document.createElement("canvas");super(e);a(this,"element");this.element=e,e.style.pointerEvents="none",e.style.zIndex="-1"}getElement(){return this.element}dispose(){super.dispose(),this.element.remove()}}const B=(c,t)=>c.size===t.size&&[...c].every(e=>t.has(e));class I{constructor(t){a(this,"element",document.createElement("div"));a(this,"dot0",document.createElement("span"));a(this,"dot1",document.createElement("span"));a(this,"dot2",document.createElement("span"));this.lyricPlayer=t,this.element.className=t.style.classes.interludeDots,this.dot0.innerText="·",this.dot1.innerText="·",this.dot2.innerText="·",this.element.appendChild(this.dot0),this.element.appendChild(this.dot1),this.element.appendChild(this.dot2)}getElement(){return this.element}dispose(){this.element.remove()}}class T{constructor(t=0){a(this,"currentPosition",0);a(this,"targetPosition",0);a(this,"currentTime",0);a(this,"params",{});a(this,"currentSolver");a(this,"getV");a(this,"queueParams",[]);a(this,"queuePosition",[]);this.targetPosition=t,this.currentPosition=this.targetPosition,this.currentSolver=()=>this.targetPosition,this.getV=()=>0}resetSolver(){const t=this.getV(this.currentTime);this.currentTime=0,this.currentSolver=q(this.currentPosition,t,this.targetPosition,0,this.params),this.getV=F(this.currentSolver)}setPosition(t){this.targetPosition=t,this.currentPosition=t,this.currentSolver=()=>this.targetPosition,this.getV=()=>0}update(t=0){this.currentTime+=t,this.currentPosition=this.currentSolver(this.currentTime);const e=this.queueParams[0];e&&(this.queueParams.forEach(r=>{r.time-=t}),e.time<=0&&(this.updateParams({mass:e.mass,damping:e.damping,stiffness:e.stiffness,soft:e.soft}),this.queueParams.shift()));const s=this.queuePosition[0];s&&(this.queuePosition.forEach(r=>{r.time-=t}),s.time<=0&&(this.setTargetPosition(s.position),this.queuePosition.shift()))}updateParams(t,e=0){e>0?(this.queueParams=this.queueParams.filter(s=>s.time<e),this.queueParams.push({...t,time:e})):(this.params={...this.params,...t},this.resetSolver())}setTargetPosition(t,e=0){e>0?(this.queuePosition=this.queuePosition.filter(s=>s.time<e),this.queuePosition.push({position:t,time:e})):(this.targetPosition=t,this.resetSolver())}getCurrentPosition(){return this.currentPosition}}function q(c,t,e,s=0,r){const n=r.soft??!1,l=r.stiffness??100,i=r.damping??10,h=r.mass??1,p=e-c;if(n||1<=i/(2*Math.sqrt(l*h))){const o=-Math.sqrt(l/h),d=-o*p-t;return m=>(m-=s,m<0?c:e-(p+m*d)*Math.E**(m*o))}else{const o=Math.sqrt(4*h*l-i**2),d=(i*p-2*h*t)/o,m=.5*o/h,y=-(.5*i)/h;return u=>(u-=s,u<0?c:e-(Math.cos(u*m)*p+Math.sin(u*m)*d)*Math.E**(u*y))}}function k(c){return e=>(c(e+.001)-c(e-.001))/(2*.001)}function F(c){return k(c)}const D=/^([\p{Unified_Ideograph}\u3006\u3007][\ufe00-\ufe0f\u{e0100}-\u{e01ef}]?)+$/u;function A(c,t="rgba(0,0,0,1)",e="rgba(0,0,0,0.5)"){const s=2+c,r=c/s,n=(1-r)/2;return[`linear-gradient(to right,${t} ${n*100}%,${e} ${(n+r)*100}%)`,r,s]}class R{constructor(t,e={words:[],translatedLyric:"",romanLyric:"",startTime:0,endTime:0,isBG:!1,isDuet:!1}){a(this,"element",document.createElement("div"));a(this,"currentTime",0);a(this,"left",0);a(this,"top",0);a(this,"scale",1);a(this,"blur",0);a(this,"delay",0);a(this,"splittedWords",[]);a(this,"lineSize",[0,0]);a(this,"lineTransforms",{posX:new T(0),posY:new T(0),scale:new T(1)});a(this,"_hide",!0);a(this,"lastStyle","");this.lyricPlayer=t,this.lyricLine=e,this.element.setAttribute("class",this.lyricPlayer.style.classes.lyricLine),this.lyricLine.isBG&&this.element.classList.add(this.lyricPlayer.style.classes.lyricBgLine),this.lyricLine.isDuet&&this.element.classList.add(this.lyricPlayer.style.classes.lyricDuetLine),this.element.appendChild(document.createElement("div")),this.element.appendChild(document.createElement("div")),this.element.appendChild(document.createElement("div"));const s=this.element.children[0],r=this.element.children[1],n=this.element.children[2];s.setAttribute("class",this.lyricPlayer.style.classes.lyricMainLine),r.setAttribute("class",this.lyricPlayer.style.classes.lyricSubLine),n.setAttribute("class",this.lyricPlayer.style.classes.lyricSubLine),this.rebuildElement(),this.rebuildStyle()}enable(){this.element.classList.add("active"),this.element.children[0].classList.add("active")}disable(){this.element.classList.remove("active"),this.element.children[0].classList.remove("active")}setLine(t){this.lyricLine=t,this.lyricLine.isBG?this.element.classList.add(this.lyricPlayer.style.classes.lyricBgLine):this.element.classList.remove(this.lyricPlayer.style.classes.lyricBgLine),this.lyricLine.isDuet?this.element.classList.add(this.lyricPlayer.style.classes.lyricDuetLine):this.element.classList.remove(this.lyricPlayer.style.classes.lyricDuetLine),this.rebuildElement(),this.rebuildStyle()}getLine(){return this.lyricLine}show(){this._hide=!1,this.rebuildStyle()}hide(){this._hide=!0,this.rebuildStyle()}rebuildStyle(){if(this._hide){this.lastStyle!=="visibility:hidden;transform:translate(0,-10000px);"&&(this.lastStyle="visibility:hidden;transform:translate(0,-10000px);",this.element.setAttribute("style","visibility:hidden;transform:translate(0,-10000px);"));return}let t=`transform:translate(${this.lineTransforms.posX.getCurrentPosition()}px,${this.lineTransforms.posY.getCurrentPosition()}px) scale(${this.lineTransforms.scale.getCurrentPosition()});`;this.lyricPlayer.disableSpring&&this.isInSight&&(t+=`transition-delay:${this.delay}ms;`),t+=`filter:blur(${this.blur}px);`,t!==this.lastStyle&&(this.lastStyle=t,this.element.setAttribute("style",t))}rebuildElement(){const t=this.element.children[0],e=this.element.children[1],s=this.element.children[2];for(this.splittedWords=[],this.lyricLine.words.forEach(n=>{if(D.test(n.word))this.splittedWords.push(...n.word.split("").map((l,i,h)=>({word:l,startTime:n.startTime+i*(n.endTime-n.startTime)/h.length,endTime:n.startTime+(i+1)*(n.endTime-n.startTime)/h.length,width:0,height:0})));else{const l=/(\s*)(\S*)(\s*)/.exec(n.word);l&&(l[1].length>0&&this.splittedWords.push({word:" ",startTime:0,endTime:0,width:0,height:0}),this.splittedWords.push({word:l[2],startTime:n.startTime,endTime:n.endTime,width:0,height:0}),l[3].length>0&&this.splittedWords.push({word:" ",startTime:0,endTime:0,width:0,height:0}))}});t.hasChildNodes();)t.removeChild(t.firstChild);let r=null;this.splittedWords.forEach(n=>{if(n.word.trim().length>0){const l=document.createElement("span");if(l.innerText=n.word,n.element=l,r)if(r.childElementCount>0)r.appendChild(l);else{const i=document.createElement("span");r.remove(),i.appendChild(r),i.appendChild(l),t.appendChild(i),r=i}else r=l,t.appendChild(l)}else if(n.word.length>0){const l=document.createTextNode(" ");t.appendChild(l),r=null}else r=null}),e.innerText=this.lyricLine.translatedLyric,s.innerText=this.lyricLine.romanLyric}updateMaskImage(){this.element.children[0],this.splittedWords.forEach((t,e)=>{const s=t.element;if(s){t.width=s.clientWidth,t.height=s.clientHeight;const[r,n,l]=A(16/t.width,"rgba(0,0,0,0.75)","rgba(0,0,0,0.25)"),i=`${l*100}% 100%`;this.lyricPlayer.supportMaskImage?(s.style.maskImage=r,s.style.maskOrigin="left",s.style.maskSize=i):(s.style.webkitMaskImage=r,s.style.webkitMaskOrigin="left",s.style.webkitMaskSize=i);const h=t.width+16,p=`clamp(${-h}px,calc(${-h}px + (var(--amll-player-time) - ${t.startTime})*${h/Math.abs(t.endTime-t.startTime)}px),0px) 0px, left top`;s.style.maskPosition=p,s.style.webkitMaskPosition=p}})}getElement(){return this.element}setTransform(t=this.left,e=this.top,s=this.scale,r=1,n=0,l=!1,i=0){this.left=t,this.top=e,this.scale=s,this.blur=n,this.delay=i*1e3|0;const h=this.element.children[0];h.style.opacity=`${r}`,l||this.lyricPlayer.disableSpring?(l&&this.element.classList.add(this.lyricPlayer.style.classes.tmpDisableTransition),this.lineTransforms.posX.setPosition(t),this.lineTransforms.posY.setPosition(e),this.lineTransforms.scale.setPosition(s),this.lyricPlayer.disableSpring?this.show():this.rebuildStyle(),l&&requestAnimationFrame(()=>{this.element.classList.remove(this.lyricPlayer.style.classes.tmpDisableTransition)})):(this.lineTransforms.posX.setTargetPosition(t,i),this.lineTransforms.posY.setTargetPosition(e,i),this.lineTransforms.scale.setTargetPosition(s),this.element.style.filter=`blur(${n}px)`)}update(t=0){this.lyricPlayer.disableSpring||(this.lineTransforms.posX.update(t),this.lineTransforms.posY.update(t),this.lineTransforms.scale.update(t),this.isInSight?this.show():this.hide())}get isInSight(){const t=this.lineTransforms.posX.getCurrentPosition(),e=this.lineTransforms.posY.getCurrentPosition(),s=t+this.lineSize[0],r=e+this.lineSize[1],n=this.lyricPlayer.pos[0],l=this.lyricPlayer.pos[1],i=this.lyricPlayer.pos[0]+this.lyricPlayer.size[0],h=this.lyricPlayer.pos[1]+this.lyricPlayer.size[1];return!(t>i||e>h||s<n||r<l)}dispose(){this.element.remove()}}const $=x.create(v());class W extends EventTarget{constructor(){super();a(this,"element",document.createElement("div"));a(this,"currentTime",0);a(this,"lyricLines",[]);a(this,"processedLines",[]);a(this,"lyricLinesEl",[]);a(this,"lyricLinesSize",new Map);a(this,"hotLines",new Set);a(this,"bufferedLines",new Set);a(this,"scrollToIndex",0);a(this,"resizeObserver",new ResizeObserver(e=>{const s=e[0].contentRect;this.size[0]=s.width,this.size[1]=s.height,this.pos[0]=s.left,this.pos[1]=s.top,this.rebuildStyle(),this.calcLayout(!0),this.lyricLinesEl.forEach(r=>r.updateMaskImage())}));a(this,"posXSpringParams",{mass:1,damping:10,stiffness:100});a(this,"posYSpringParams",{mass:1,damping:15,stiffness:100});a(this,"scaleSpringParams",{mass:1,damping:20,stiffness:100});a(this,"enableBlur",!0);a(this,"interludeDots");a(this,"interludeDotsSize",[0,0]);a(this,"supportPlusLighter",CSS.supports("mix-blend-mode","plus-lighter"));a(this,"supportMaskImage",CSS.supports("mask-image","none"));a(this,"disableSpring",!1);a(this,"alignAnchor",.5);a(this,"size",[0,0]);a(this,"pos",[0,0]);a(this,"style",$.createStyleSheet({lyricPlayer:{userSelect:"none",padding:"1rem",boxSizing:"border-box",fontSize:"max(5vh, 12px)",fontWeight:"bold",width:"100%",height:"100%",overflow:"hidden",maxWidth:"100%",maxHeight:"100%",zIndex:1,color:"var(--amll-lyric-line-color)",mixBlendMode:"plus-lighter",contain:"strict"},lyricLine:{position:"absolute",transformOrigin:"left",maxWidth:"65%",padding:"2vh 0",contain:"content",transition:"filter 0.25s"},"@media (max-width: 1024px)":{lyricLine:{maxWidth:"75%",padding:"1vh 0"}},lyricDuetLine:{textAlign:"right",transformOrigin:"right"},lyricBgLine:{opacity:0,fontSize:"max(50%, 10px)",transition:"opacity 0.25s","&.active":{transition:"opacity 0.25s 0.25s",opacity:1}},lyricMainLine:{transition:"opacity 0.3s 0.25s","& span":{display:"inline-block",whiteSpace:"pre-wrap"}},lyricSubLine:{fontSize:"max(50%, 10px)",opacity:.5},disableSpring:{"& > *":{transition:"filter 0.25s, transform 0.5s"}},interludeDots:{fontSize:"max(150%, 10px)",transformOrigin:"left",width:"fit-content",position:"absolute",opacity:.25},"@supports (mix-blend-mode: plus-lighter)":{lyricMainLine:{},lyricSubLine:{opacity:.3}},tmpDisableTransition:{transition:"none !important"}}));this.interludeDots=new I(this),this.element.setAttribute("class",this.style.classes.lyricPlayer),this.disableSpring&&this.element.classList.add(this.style.classes.disableSpring),this.rebuildStyle(),this.resizeObserver.observe(this.element),this.element.appendChild(this.interludeDots.getElement()),this.style.attach()}setEnableSpring(e=!0){this.disableSpring=!e,e?this.element.classList.remove(this.style.classes.disableSpring):this.element.classList.add(this.style.classes.disableSpring),this.calcLayout(!0)}getCurrentInterlude(){var s,r,n;if(this.bufferedLines.size>0)return;const e=this.scrollToIndex;if(e===0){if((s=this.processedLines[0])!=null&&s.startTime&&this.processedLines[0].startTime>this.currentTime)return[0,this.processedLines[0].startTime]}else if((r=this.processedLines[e])!=null&&r.endTime&&((n=this.processedLines[e+1])!=null&&n.startTime)&&this.processedLines[e+1].startTime>this.currentTime&&this.processedLines[e].endTime<this.currentTime)return[this.processedLines[e].endTime,this.processedLines[e+1].startTime]}rebuildStyle(){let e="";e+="--amll-lyric-player-width:",e+=this.element.clientWidth,e+="px;",e+="--amll-lyric-player-height:",e+=this.element.clientHeight,e+="px;",e+="--amll-lyric-line-color:",e+="#FFFFFF;",e+="--amll-player-time:",e+=this.currentTime,e+=";",this.element.setAttribute("style",e)}setEnableBlur(e){this.enableBlur!==e&&(this.enableBlur=e,this.calcLayout())}setLyricLines(e){this.lyricLines=e;const s=750;this.processedLines=e.map((r,n,l)=>{if(r.isBG)return{...r};{const i=l[n-1],h=l[n-2];if(i!=null&&i.isBG&&h){if(h.endTime<r.startTime)return{...r,startTime:Math.max(h.endTime,r.startTime-s)||r.startTime}}else if(i!=null&&i.endTime&&i.endTime<r.startTime)return{...r,startTime:Math.max(i==null?void 0:i.endTime,r.startTime-s)||r.startTime};return{...r}}}),this.lyricLinesEl.forEach(r=>r.dispose()),this.lyricLinesEl=this.processedLines.map(r=>new R(this,r)),this.lyricLinesEl.forEach(r=>(this.element.appendChild(r.getElement()),r.updateMaskImage())),this.setLinePosXSpringParams({}),this.setLinePosYSpringParams({}),this.setLineScaleSpringParams({}),this.calcLayout(!0)}calcLayout(e=!1){e&&(this.lyricLinesEl.forEach(o=>{const d=[o.getElement().clientWidth,o.getElement().clientHeight];this.lyricLinesSize.set(o,d),o.lineSize=d}),this.interludeDotsSize[0]=this.interludeDots.getElement().clientWidth,this.interludeDotsSize[1]=this.interludeDots.getElement().clientHeight);const s=.95;let n=-this.lyricLinesEl.slice(0,this.scrollToIndex).reduce((o,d)=>o+(d.getLine().isBG?0:this.lyricLinesSize.get(d)[1]),0);if(this.alignAnchor==="bottom"){n+=this.element.clientHeight/2;const o=this.lyricLinesEl[this.scrollToIndex];if(o){const d=this.lyricLinesSize.get(o)[1];n-=d/2}}else if(typeof this.alignAnchor=="number"){n+=this.element.clientHeight*this.alignAnchor;const o=this.lyricLinesEl[this.scrollToIndex];if(o){const d=this.lyricLinesSize.get(o)[1];n-=d/2}}const l=this.currentTime===0?void 0:this.getCurrentInterlude();let i=0;if(l&&(i=l[1]-l[0],i>=5e3)){const o=this.currentTime===0?this.lyricLinesEl[0]:this.lyricLinesEl[this.scrollToIndex+1];o&&(n-=this.lyricLinesSize.get(o)[1])}const h=Math.max(...this.bufferedLines);let p=0;this.lyricLinesEl.forEach((o,d)=>{const m=this.bufferedLines.has(d)||d>=this.scrollToIndex&&d<h,y=o.getLine();let u=0;y.isDuet&&(u=this.size[0]-this.lyricLinesSize.get(o)[0]),d===this.scrollToIndex+1&&i>=5e3&&(n+=this.interludeDotsSize[1]),o.setTransform(u,n,m?1:s,!m&&d<=this.scrollToIndex?1/3:1,this.enableBlur?3*(m?0:1+(d<this.scrollToIndex?Math.abs(this.scrollToIndex-d):Math.abs(d-Math.max(this.scrollToIndex,h)))):0,e,p),y.isBG&&m?n+=this.lyricLinesSize.get(o)[1]:y.isBG||(n+=this.lyricLinesSize.get(o)[1]),n>=0&&(p+=.05)})}getCurrentTime(){return this.currentTime}getLyrics(){return this.lyricLines}getElement(){return this.element}setCurrentTime(e,s=!1){this.currentTime=e,this.element.style.setProperty("--amll-player-time",`${e}`);const r=new Set,n=new Set,l=new Set;this.hotLines.forEach(i=>{const h=this.processedLines[i];if(!h.isBG)if(h){const p=this.processedLines[i+1];if(p!=null&&p.isBG){const o=Math.min(h.startTime,p==null?void 0:p.startTime),d=Math.max(h.endTime,p==null?void 0:p.endTime);(o>e||d<=e)&&(this.hotLines.delete(i),r.add(i),this.hotLines.delete(i+1),r.add(i+1),s&&(this.lyricLinesEl[i].disable(),this.lyricLinesEl[i+1].disable()))}else(h.startTime>e||h.endTime<=e)&&(this.hotLines.delete(i),r.add(i),s&&this.lyricLinesEl[i].disable())}else this.hotLines.delete(i),r.add(i),s&&this.lyricLinesEl[i].disable()}),this.bufferedLines.forEach(i=>{this.hotLines.has(i)||(this.bufferedLines.delete(i),n.add(i),s&&this.lyricLinesEl[i].disable())}),this.processedLines.forEach((i,h,p)=>{var o;!i.isBG&&i.startTime<=e&&i.endTime>e&&(this.hotLines.has(h)||(this.hotLines.add(h),l.add(h),s&&this.lyricLinesEl[h].enable(),(o=p[h+1])!=null&&o.isBG&&(this.hotLines.add(h+1),l.add(h+1),s&&this.lyricLinesEl[h+1].enable())))}),s?(this.bufferedLines.size>0?this.scrollToIndex=Math.min(...this.bufferedLines):this.scrollToIndex=this.processedLines.findIndex(i=>i.startTime>=e),this.bufferedLines.clear(),this.hotLines.forEach(i=>this.bufferedLines.add(i)),this.calcLayout(!0)):(n.size>0||l.size>0)&&(n.size===0&&l.size>0?(l.forEach(i=>{this.bufferedLines.add(i),this.lyricLinesEl[i].enable()}),this.scrollToIndex=Math.min(...this.bufferedLines)):l.size===0&&n.size>0?B(n,this.bufferedLines)&&this.bufferedLines.forEach(i=>{this.hotLines.has(i)||(this.bufferedLines.delete(i),this.lyricLinesEl[i].disable())}):(l.forEach(i=>{this.bufferedLines.add(i),this.lyricLinesEl[i].enable()}),n.forEach(i=>{this.bufferedLines.delete(i),this.lyricLinesEl[i].disable()}),this.bufferedLines.size>0&&(this.scrollToIndex=Math.min(...this.bufferedLines))),this.calcLayout())}update(e=0){e/=1e3,this.lyricLinesEl.forEach(s=>s.update(e))}setLinePosXSpringParams(e){this.posXSpringParams={...this.posXSpringParams,...e},this.lyricLinesEl.forEach(s=>s.lineTransforms.posX.updateParams(this.posXSpringParams))}setLinePosYSpringParams(e){this.posYSpringParams={...this.posYSpringParams,...e},this.lyricLinesEl.forEach(s=>s.lineTransforms.posY.updateParams(this.posYSpringParams))}setLineScaleSpringParams(e){this.scaleSpringParams={...this.scaleSpringParams,...e},this.lyricLinesEl.forEach(s=>s.lineTransforms.scale.updateParams(this.scaleSpringParams))}dispose(){this.element.remove(),this.resizeObserver.disconnect(),this.style.detach(),this.lyricLinesEl.forEach(e=>e.dispose())}}exports.BackgroundRender=z;exports.LyricPlayer=W;
