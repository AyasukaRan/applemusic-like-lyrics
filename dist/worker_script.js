(()=>{var Q=Object.defineProperty;var X=(r,e,t)=>e in r?Q(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var F=(r,e,t)=>(X(r,typeof e!="symbol"?e+"":e,t),t);var O=new EventTarget;function N(r,e){let t=0;return function(){let s=this,i=arguments;t&&clearTimeout(t),t=setTimeout(r.bind(s,i),e)}}function j(r){let e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",t=[];for(let o=0;o<r;o++)t.push(e.charAt(Math.floor(Math.random()*e.length)));return t.join("")}var g=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope;var Y=()=>{};var C=Y,k=g?(...r)=>console.warn("[AMLL-Worker]",...r):console.warn,z=g?(...r)=>console.error("[AMLL-Worker]",...r):console.error;var P="Apple-Musiclike-lyrics";var G=`config.betterncm.${"plugin"in globalThis?plugin?.manifest?.slug||plugin?.manifest?.name||P:P}`,I=te();function te(){if(g)return{};try{return JSON.parse(localStorage.getItem(G)||"{}")}catch(r){return k("\u8B66\u544A\uFF1AAMLL \u63D2\u4EF6\u914D\u7F6E\u8BFB\u53D6\u5931\u8D25",r),{}}}var re=N(function(){if(g){O.dispatchEvent(new Event("config-saved"));return}try{localStorage.setItem(G,JSON.stringify(I))}catch(e){k("\u8B66\u544A\uFF1AAMLL \u63D2\u4EF6\u914D\u7F6E\u4FDD\u5B58\u5931\u8D25",e)}O.dispatchEvent(new Event("config-saved"))},2e3);function D(r,e){g||K({[r]:e}),e===void 0?delete I[r]:I[r]=e,re()}var x=class extends Array{constructor(t=(o,s)=>Number(o)-Number(s)){super();this._comparator=t}_sorted=!1;sort=t=>(this._comparator=t||this._comparator,this._sorted=!0,super.sort(this._comparator));push=t=>(this._sorted=!1,super.push(t));pop=()=>(this._sorted||this.sort(),super.pop());peek=t=>(this._sorted||this.sort(),t===void 0&&(t=this.length-1),this[t]);size=()=>this.length;debug=()=>(this._sorted||this.sort(),this)};var v=class{constructor(e,t,o,s,i,c,a){this.r1=e;this.r2=t;this.g1=o;this.g2=s;this.b1=i;this.b2=c;this.histo=a}_count=-1;_volume=0;_avg=[];volume=e=>this._volume&&!e?this._volume:(this._volume=(this.r2-this.r1+1)*(this.g2-this.g1+1)*(this.b2-this.b1+1),this._volume);count=e=>{if(this._count>-1&&!e)return this._count;let t=0,o,s,i,c;for(o=this.r1;o<=this.r2;o++)for(s=this.g1;s<=this.g2;s++)for(i=this.b1;i<=this.b2;i++)c=d(o,s,i),t+=this.histo[c]||0;return this._count=t,this._count};copy=()=>new v(this.r1,this.r2,this.g1,this.g2,this.b1,this.b2,this.histo);avg=e=>{if(this._avg.length&&e)return this._avg;let t=0,o=1<<_,s=0,i=0,c=0,a,n,u,l,m;for(n=this.r1;n<=this.r2;n++)for(u=this.g1;u<=this.g2;u++)for(l=this.b1;l<=this.b2;l++)m=d(n,u,l),a=this.histo[m]||0,t+=a,s+=a*(n+.5)*o,i+=a*(u+.5)*o,c+=a*(l+.5)*o;return t?this._avg=[~~(s/t),~~(i/t),~~(c/t)]:this._avg=[~~(o*(this.r1+this.r2+1)/2),~~(o*(this.g1+this.g2+1)/2),~~(o*(this.b1+this.b2+1)/2)],this._avg};contains=e=>{let[t,o,s]=e.map(i=>i>>_);return t>=this.r1&&t<=this.r2&&o>=this.g1&&o<=this.g2&&s>=this.b1&&s<=this.b2}};var R=5,_=8-R,W=1e3,H=.75,h={naturalOrder:(r,e)=>r<e?-1:r>e?1:0,sum:(r,e)=>r.reduce((t,o)=>t+(e?e.call(r,o):Number(o)),0),max:(r,e)=>Math.max.apply(null,e?r.map(e):r.map(t=>Number(t))),size:r=>r.reduce((e,t)=>t?e+1:e,0)},d=(r,e,t)=>(r<<2*R)+(e<<R)+t;var $=r=>{let e=new Array(1<<3*R),t,o=1/0,s=0,i=1/0,c=0,a=1/0,n=0,u,l,m;return r.forEach(function(p){[u,l,m]=p.map(f=>f>>_),t=d(u,l,m),e[t]=(e[t]||0)+1,u<o?o=u:u>s&&(s=u),l<i?i=l:l>c&&(c=l),m<a?a=m:m>n&&(n=m)}),{vbox:new v(o,s,i,c,a,n,e),histo:e}},U=(r,e)=>{if(!e.count())return[];if(e.count()===1)return[e.copy()];let t=e.r2-e.r1+1,o=e.g2-e.g1+1,s=e.b2-e.b1+1,i=h.max([t,o,s]),c=[],a=0,n,u,l,m,p;if(i===t)for(n=e.r1;n<=e.r2;n++){for(m=0,u=e.g1;u<=e.g2;u++)for(l=e.b1;l<=e.b2;l++)p=d(n,u,l),m+=r[p]||0;a+=m,c[n]=a}else if(i===o)for(n=e.g1;n<=e.g2;n++){for(m=0,u=e.r1;u<=e.r2;u++)for(l=e.b1;l<=e.b2;l++)p=d(u,n,l),m+=r[p]||0;a+=m,c[n]=a}else for(n=e.b1;n<=e.b2;n++){for(m=0,u=e.r1;u<=e.r2;u++)for(l=e.g1;l<=e.g2;l++)p=d(u,l,n),m+=r[p]||0;a+=m,c[n]=a}let f=V=>{let M=`${V}1`,y=`${V}2`,L,B,T,E,b;for(n=e[M];n<=e[y]&&!(c[n]>=a/2);n++);for(T=e.copy(),E=e.copy(),L=n-e[M],B=e[y]-n,b=L<=B?Math.min(e[y]-1,~~(n+B/2)):Math.max(e[M],~~(n-1-L/2));!c[b]&&b<=e[y];)b++;return T[y]=b,E[M]=b+1,[T,E]};return f(i===t?"r":i===o?"g":"b")};var A=class{vboxes;constructor(){this.vboxes=new x(A._compare)}push=e=>{this.vboxes.push({vbox:e,color:e.avg()})};palette=()=>this.vboxes.map(e=>e.color);size=()=>this.vboxes.size();map=e=>{for(let t=0;t<this.vboxes.size();t++)if(this.vboxes.peek(t).vbox.contains(e))return this.vboxes.peek(t).color;return this.nearest(e)};nearest=e=>{let t,o,s,i;for(t=0;t<this.vboxes.size();t++)s=Math.sqrt(Math.pow(e[0]-this.vboxes.peek(t).color[0],2)+Math.pow(e[1]-this.vboxes.peek(t).color[1],2)+Math.pow(e[2]-this.vboxes.peek(t).color[2],2)),(o===void 0||s<o)&&(o=s,i=this.vboxes.peek(t).color);return i};forcebw=()=>{this.vboxes.sort((s,i)=>h.naturalOrder(h.sum(s.color),h.sum(i.color)));let e=this.vboxes[0].color;e[0]<5&&e[1]<5&&e[2]<5&&(this.vboxes[0].color=[0,0,0]);let t=this.vboxes.length-1,o=this.vboxes[t].color;o[0]>251&&o[1]>251&&o[2]>251&&(this.vboxes[t].color=[255,255,255]),this.vboxes.sort(A._compare)}},w=A;F(w,"_compare",(e,t)=>h.naturalOrder(e.vbox.count()*e.vbox.volume(),t.vbox.count()*t.vbox.volume()));var q=(r,e)=>{if(!r.length||e<1||e>256)return new w;let{histo:t,vbox:o}=$(r),s=new x((a,n)=>h.naturalOrder(a.count(),n.count()));s.push(o);let i=(a,n)=>{let u=a.size(),l=0,m;for(;l<W;){if(u>=n||l++>W||!a.peek().count())return;m=a.pop();let[p,f]=U(t,m);if(!p)return;a.push(p),f&&(a.push(f),u++)}};i(s,H*e),s.sort((a,n)=>h.naturalOrder(a.count()*a.volume(),n.count()*n.volume())),i(s,e);let c=new w;for(;s.size();)c.push(s.pop());return c};var J;var S={},ne=new Map;function Z(r,e,t=[]){S[r]={funcName:r,funcBody:e};let o=0;return(...s)=>{if(J)return new Promise((i,c)=>{let a=`${j(4)} - ${r} - ${o++}`;ne.set(a,[i,c]),J.postMessage({id:a,funcName:r,args:s},t.map(n=>s[n]).filter(n=>!!n))});k("AMLL Worker \u5C1A\u672A\u8FD0\u884C\uFF0C\u6B63\u5728\u672C\u5730\u7EBF\u7A0B\u6267\u884C\u51FD\u6570",r,s);try{let i=e(...s);return Promise.resolve(i)}catch(i){return Promise.reject(i)}}}var ze=Z("grabImageColors",async(r,e=16)=>{let t=new OffscreenCanvas(r.width,r.height),o=t.getContext("2d");if(o){o.drawImage(r,0,0);let s=o.getImageData(0,0,t.width,t.height),i=[];for(let n=0;n<s.width*s.height;n++)i.push([s.data[n*4],s.data[n*4+1],s.data[n*4+2]]);let c=q(i,e),a=[];return c.palette().forEach(n=>a.push(n)),a}else return[]}),K=Z("setConfigFromMain",r=>{if(g){for(let e in r)D(e,r[e]);C("\u5DF2\u4ECE\u4E3B\u7EBF\u7A0B\u540C\u6B65\u914D\u7F6E",...Object.keys(r))}});onmessage=async r=>{try{C("\u6B63\u5728\u6267\u884C\u540E\u53F0\u4EFB\u52A1",r.data.id,r.data.funcName,r.data.args);let t=await S[r.data.funcName].funcBody(...r.data.args);postMessage({id:r.data.id,result:t})}catch(e){z("\u540E\u53F0\u4EFB\u52A1\u53D1\u751F\u9519\u8BEF",r.data.id,r.data.funcName,r.data.args,e),postMessage({id:r.data.id,result:void 0,error:e})}};C("AMLL \u540E\u53F0\u7EBF\u7A0B\u6B63\u5728\u8FD0\u884C\uFF01");})();
