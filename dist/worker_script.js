"use strict";(()=>{var Q=Object.defineProperty;var Y=(r,e,t)=>e in r?Q(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var g=(r,e,t)=>(Y(r,typeof e!="symbol"?e+"":e,t),t);var h=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope;var ee=()=>{};var b=ee,k=h?(...r)=>console.warn("[AMLL-Worker]",...r):console.warn,D=h?(...r)=>console.error("[AMLL-Worker]",...r):console.error;var S=new EventTarget;var te=r=>{let e=typeof r;if(e!=="string")throw new TypeError(`Expected a string, got a ${e}`)},re=(r,e)=>{let t="",n=0,o=-1,i=0,l;for(let a=0;a<=r.length;++a){if(a<r.length)l=r.charCodeAt(a);else{if(l===47)break;l=47}if(l===47){if(!(o===a-1||i===1))if(o!==a-1&&i===2){if(t.length<2||n!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){let s=t.lastIndexOf("/");if(s!==t.length-1){s===-1?(t="",n=0):(t=t.slice(0,s),n=t.length-1-t.lastIndexOf("/")),o=a,i=0;continue}}else if(t.length===2||t.length===1){t="",n=0,o=a,i=0;continue}}e&&(t.length>0?t+="/..":t="..",n=2)}else t.length>0?t+=`/${r.slice(o+1,a)}`:t=r.slice(o+1,a),n=a-o-1;o=a,i=0}else l===46&&i!==-1?++i:i=-1}return t},ne=r=>{try{return decodeURIComponent(r)}catch(e){return r}},E=r=>{te(r);let e=r.replaceAll("\\","/");if(e.length===0)return".";let t=e.charCodeAt(0)===47,n=e.charCodeAt(e.length-1)===47;return e=ne(e),e=re(e,!t),e.length===0&&!t&&(e="."),e.length>0&&n&&(e+="/"),t?`/${e}`:e};function z(r,e){let t=0;return function(){let o=this,i=arguments;t&&clearTimeout(t),t=setTimeout(r.bind(o,i),e)}}var y={},W=()=>E(`${plugin.mainPlugin.pluginPath}/../../amll-data`),oe=()=>E(`${W()}/amll-settings.json`);h||window.addEventListener("unload",j);async function j(){if(h){S.dispatchEvent(new Event("config-saved"));return}try{await betterncm.fs.exists(W())||await betterncm.fs.mkdir(W()),await betterncm.fs.writeFile(oe(),JSON.stringify(y)),b("AMLL 插件配置保存成功")}catch(r){k("警告：AMLL 插件配置保存失败",r)}S.dispatchEvent(new Event("config-saved"))}var se=z(j,500);function G(r,e){h||K({[r]:e}),e===void 0?delete y[r]:y[r]=e,se()}function $(r){let e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",t=[];for(let n=0;n<r;n++)t.push(e.charAt(Math.floor(Math.random()*e.length)));return t.join("")}var w=class extends Array{constructor(t=(n,o)=>Number(n)-Number(o)){super();this._comparator=t;g(this,"_sorted",!1);g(this,"sort",t=>(this._comparator=t||this._comparator,this._sorted=!0,super.sort(this._comparator)));g(this,"push",t=>(this._sorted=!1,super.push(t)));g(this,"pop",()=>(this._sorted||this.sort(),super.pop()));g(this,"peek",t=>(this._sorted||this.sort(),t===void 0&&(t=this.length-1),this[t]));g(this,"size",()=>this.length);g(this,"debug",()=>(this._sorted||this.sort(),this))}};var v=class{constructor(e,t,n,o,i,l,a){this.r1=e;this.r2=t;this.g1=n;this.g2=o;this.b1=i;this.b2=l;this.histo=a;g(this,"_count",-1);g(this,"_volume",0);g(this,"_avg",[0,0,0]);g(this,"volume",e=>this._volume&&!e?this._volume:(this._volume=(this.r2-this.r1+1)*(this.g2-this.g1+1)*(this.b2-this.b1+1),this._volume));g(this,"count",e=>{if(this._count>-1&&!e)return this._count;let t=0,n,o,i,l;for(n=this.r1;n<=this.r2;n++)for(o=this.g1;o<=this.g2;o++)for(i=this.b1;i<=this.b2;i++)l=x(n,o,i),t+=this.histo[l]||0;return this._count=t,this._count});g(this,"copy",()=>new v(this.r1,this.r2,this.g1,this.g2,this.b1,this.b2,this.histo));g(this,"avg",e=>{if(this._avg.length&&e)return this._avg;let t=0,n=1<<M,o=0,i=0,l=0,a,s,u,c,f;for(s=this.r1;s<=this.r2;s++)for(u=this.g1;u<=this.g2;u++)for(c=this.b1;c<=this.b2;c++)f=x(s,u,c),a=this.histo[f]||0,t+=a,o+=a*(s+.5)*n,i+=a*(u+.5)*n,l+=a*(c+.5)*n;return t?this._avg=[~~(o/t),~~(i/t),~~(l/t)]:this._avg=[~~(n*(this.r1+this.r2+1)/2),~~(n*(this.g1+this.g2+1)/2),~~(n*(this.b1+this.b2+1)/2)],this._avg});g(this,"contains",e=>{let[t,n,o]=e.map(i=>i>>M);return t>=this.r1&&t<=this.r2&&n>=this.g1&&n<=this.g2&&o>=this.b1&&o<=this.b2})}};var T=5,M=8-T,V=1e3,U=.75,p={naturalOrder:(r,e)=>r<e?-1:r>e?1:0,sum:(r,e)=>r.reduce((t,n)=>t+(e?e.call(r,n):Number(n)),0),max:(r,e)=>Math.max.apply(null,e?r.map(e):r.map(t=>Number(t))),size:r=>r.reduce((e,t)=>t?e+1:e,0)},x=(r,e,t)=>(r<<2*T)+(e<<T)+t;var q=r=>{let e=new Array(1<<3*T),t,n=1/0,o=0,i=1/0,l=0,a=1/0,s=0,u,c,f;return r.forEach(function(m){[u,c,f]=m.map(d=>d>>M),t=x(u,c,f),e[t]=(e[t]||0)+1,u<n?n=u:u>o&&(o=u),c<i?i=c:c>l&&(l=c),f<a?a=f:f>s&&(s=f)}),{vbox:new v(n,o,i,l,a,s,e),histo:e}},X=(r,e)=>{if(!e.count())return[];if(e.count()===1)return[e.copy()];let t=e.r2-e.r1+1,n=e.g2-e.g1+1,o=e.b2-e.b1+1,i=p.max([t,n,o]),l=[],a=0,s,u,c,f,m;if(i===t)for(s=e.r1;s<=e.r2;s++){for(f=0,u=e.g1;u<=e.g2;u++)for(c=e.b1;c<=e.b2;c++)m=x(s,u,c),f+=r[m]||0;a+=f,l[s]=a}else if(i===n)for(s=e.g1;s<=e.g2;s++){for(f=0,u=e.r1;u<=e.r2;u++)for(c=e.b1;c<=e.b2;c++)m=x(u,s,c),f+=r[m]||0;a+=f,l[s]=a}else for(s=e.b1;s<=e.b2;s++){for(f=0,u=e.r1;u<=e.r2;u++)for(c=e.g1;c<=e.g2;c++)m=x(u,c,s),f+=r[m]||0;a+=f,l[s]=a}let d=N=>{let O=`${N}1`,A=`${N}2`,P,R,_,B,C;for(s=e[O];s<=e[A]&&!(l[s]>=a/2);s++);for(_=e.copy(),B=e.copy(),P=s-e[O],R=e[A]-s,C=P<=R?Math.min(e[A]-1,~~(s+R/2)):Math.max(e[O],~~(s-1-P/2));!l[C]&&C<=e[A];)C++;return _[A]=C,B[O]=C+1,[_,B]};return d(i===t?"r":i===n?"g":"b")};var I=class{constructor(){g(this,"vboxes");g(this,"push",e=>{this.vboxes.push({vbox:e,color:e.avg()})});g(this,"palette",()=>this.vboxes.map(e=>e.color));g(this,"size",()=>this.vboxes.size());g(this,"map",e=>{for(let t=0;t<this.vboxes.size();t++)if(this.vboxes.peek(t).vbox.contains(e))return this.vboxes.peek(t).color;return this.nearest(e)});g(this,"nearest",e=>{let t,n,o,i;for(t=0;t<this.vboxes.size();t++)o=Math.sqrt(Math.pow(e[0]-this.vboxes.peek(t).color[0],2)+Math.pow(e[1]-this.vboxes.peek(t).color[1],2)+Math.pow(e[2]-this.vboxes.peek(t).color[2],2)),(n===void 0||o<n)&&(n=o,i=this.vboxes.peek(t).color);return i});g(this,"forcebw",()=>{this.vboxes.sort((o,i)=>p.naturalOrder(p.sum(o.color),p.sum(i.color)));let e=this.vboxes[0].color;e[0]<5&&e[1]<5&&e[2]<5&&(this.vboxes[0].color=[0,0,0]);let t=this.vboxes.length-1,n=this.vboxes[t].color;n[0]>251&&n[1]>251&&n[2]>251&&(this.vboxes[t].color=[255,255,255]),this.vboxes.sort(I._compare)});this.vboxes=new w(I._compare)}},L=I;g(L,"_compare",(e,t)=>p.naturalOrder(e.vbox.count()*e.vbox.volume(),t.vbox.count()*t.vbox.volume()));var J=(r,e)=>{if(!r.length||e<1||e>256)return new L;let{histo:t,vbox:n}=q(r),o=new w((a,s)=>p.naturalOrder(a.count(),s.count()));o.push(n);let i=(a,s)=>{let u=a.size(),c=0,f;for(;c<V;){if(u>=s||c++>V||!a.peek().count())return;f=a.pop();let[m,d]=X(t,f);if(!m)return;a.push(m),d&&(a.push(d),u++)}};i(o,U*e),o.sort((a,s)=>p.naturalOrder(a.count()*a.volume(),s.count()*s.volume())),i(o,e);let l=new L;for(;o.size();)l.push(o.pop());return l};var Z;var F={},ie=new Map;function H(r,e,t=[]){F[r]={funcName:r,funcBody:e};let n=0;return(...o)=>{if(Z)return new Promise((i,l)=>{let a=`${$(4)} - ${r} - ${n++}`;ie.set(a,[i,l]),Z.postMessage({id:a,funcName:r,args:o},t.map(s=>o[s]).filter(s=>!!s))});APP_CONF.isOSX||k("AMLL Worker 尚未运行，正在本地线程执行函数",r,o);try{let i=e(...o);return Promise.resolve(i)}catch(i){return Promise.reject(i)}}}var Je=H("grabImageColors",(r,e=16)=>{let t,n;if(h||!APP_CONF.isOSX?(t=new OffscreenCanvas(r.width,r.height),n=t.getContext("2d")):(t=document.createElement("canvas"),t.width=r.width,t.height=r.height,n=t.getContext("2d")),n){n.drawImage(r,0,0);let o=n.getImageData(0,0,t.width,t.height),i=[];for(let s=0;s<o.width*o.height;s++)i.push([o.data[s*4],o.data[s*4+1],o.data[s*4+2]]);let l=J(i,e),a=[];return l.palette().forEach(s=>a.push(s)),a}else return[]}),Ze=H("calcImageAverageColor",r=>{let e,t;if(h||!APP_CONF.isOSX?(e=new OffscreenCanvas(r.width,r.height),t=e.getContext("2d")):(e=document.createElement("canvas"),e.width=r.width,e.height=r.height,t=e.getContext("2d")),t){t.drawImage(r,0,0);let n=t.getImageData(0,0,e.width,e.height),o=[0,0,0];for(let i=0;i<n.width*n.height;i++)o[0]+=n.data[i*4],o[1]+=n.data[i*4+1],o[2]+=n.data[i*4+2];return o[0]/=n.width*n.height,o[1]/=n.width*n.height,o[2]/=n.width*n.height,o}else return[0,0,0]}),K=H("setConfigFromMain",r=>{if(h){for(let e in r)G(e,r[e]);b("已从主线程同步配置",...Object.keys(r))}});onmessage=async r=>{try{b("正在执行后台任务",r.data.id,r.data.funcName,r.data.args);let t=await F[r.data.funcName].funcBody(...r.data.args);postMessage({id:r.data.id,result:t})}catch(e){D("后台任务发生错误",r.data.id,r.data.funcName,r.data.args,e),postMessage({id:r.data.id,result:void 0,error:e})}};b("AMLL 后台线程正在运行！");})();
